<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Homelab Raspberry Pi Kubernetes Cluster Current State | Josh Kasuboski</title><meta name=description content="The k3s cluster is alive and well"><meta name=author content><link rel=apple-touch-icon sizes=180x180 href=https://www.joshkasuboski.com/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.joshkasuboski.com/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.joshkasuboski.com/favicon-16x16.png><link rel=manifest href=https://www.joshkasuboski.com/site.webmanifest><link rel=mask-icon href=https://www.joshkasuboski.com/safari-pinned-tab.svg color=#00416a><meta name=msapplication-TileColor content="#00aba9"><meta name=theme-color content="#ffffff"><link rel=me href=mailto:josh.kasuboski@gmail.com><link rel=me href=https://github.com/kasuboski><link rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link rel=microsub href=https://aperture.p3k.io/microsub/465><link rel=alternate type=application/rss+xml href=https://www.joshkasuboski.com/index.xml><link rel=stylesheet href=https://www.joshkasuboski.com/css/fonts.css><link rel=stylesheet href=https://www.joshkasuboski.com/css/style.css><meta name=viewport content="width=device-width,initial-scale=1"></head><body><div id=sitelogo><a class=glyph alt=Home href=https://www.joshkasuboski.com/><img src=https://www.joshkasuboski.com/images/site-logo.svg alt="Site Logo" height=64px width=64px></a></div><header><nav><div id=page-nav><div class=page-nav-item><a href=https://www.joshkasuboski.com/>Home</a></div><div class=page-nav-item><a href=/about/><span>About</span></a></div><div class=page-nav-item><a href=/now/><span>Now</span></a></div></div></nav></header><div id=content><article class=h-entry><header><h1 class="post-title p-name">Homelab Raspberry Pi Kubernetes Cluster Current State</h1><p class=post-date>Posted on
<time class=dt-published datetime=2020-05-10T12:20:48-05:00>10 May, 2020 at 12:20 -0500</time> by <a href=https://www.joshkasuboski.com/ class="p-author h-card" rel=author>Josh Kasuboski</a></p></header><section class="content e-content"><p>The cluster is alive and well and exposed to the internet ðŸ˜±</p><p>In a previous <a href=https://www.joshkasuboski.com/posts/home-k8s-raspberry-pi/>post</a>, I put out my plan for the cluster. I mostly followed along, but did end up getting <a href=https://www.amazon.com/gp/product/B00A128S24>this</a> switch and <a href=https://www.amazon.com/gp/product/B003L1AET2>these</a> ethernet cables.</p><p>I ended up with this set-up which is described in more detail below.</p><figure><a href=traffic-diagram.svg><img src=traffic-diagram.svg alt="Traffic Diagram"></a></figure><h2 id=hardware-and-monitoring>Hardware and Monitoring</h2><p>The cluster is set up with Raspbian Lite on 3 Raspberry Pi 4 4gb boards. Raspbian Lite seems to not support 64bit (yet) so I may be changing the operating system. The cluster has the monitoring stack from carlosedp's <a href=https://github.com/carlosedp/cluster-monitoring>repo</a>. I changed some things (mainly the ingress) in my forked <a href=https://github.com/kasuboski/cluster-monitoring>repo</a>.</p><p>This deploys some nice Grafana dashboards to see the state of the cluster as seen below. <code>blueberry</code> is the master node so hovers around 768m cpu cores and 1285Mi memory usage.</p><figure><a href=cluster-metrics.png><img src=cluster-metrics.png alt="Cluster Metrics"></a></figure><h2 id=ingress>Ingress</h2><p>This dashboard is exposed outside the cluster using <a href=https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#over-a-nodeport-service>ingress-nginx</a> with NodePorts. These nodeports are load balanced by an haproxy running in a container on my existing Raspberry Pi 3B+. This is a single point of failure for ingress ðŸ˜°, but should be good enough for now.</p><p>The Ingress is secured using <a href=https://github.com/vouch/vouch-proxy>vouch-proxy</a> with the ingress-nginx auth <a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/>annotations</a>. It uses the <a href=https://indieauth.net/>IndieAuth</a> backend so I can login using this site as an identity.</p><h2 id=expose-to-the-world>Expose to the world</h2><p>The final piece of the puzzle to expose cluster services to the internet is a Linode <a href=https://www.linode.com/products/nanodes/>nanode</a>. I chose Linode largely because I had a credit&mldr; It's really just providing a public ip address that can forward to my network. I didn't set up port forwarding to my network instead the haproxy Raspberry Pi and the Linode VM are running <a href=https://tailscale.com/>tailscale</a>.</p><p>Tailscale allows the nanode to connect to my Raspberry Pi with a WireGuard connection through my crazy NAT situation. The nanode is also running an haproxy on ports 80 and 443 on the public ip interface and then proxying that to the tailscale ip of the Raspberry Pi.</p><p>I changed the DNS of <code>*.joshcorp.co</code> to point to the nanode. Now that <code>*.joshcorp.co</code> resolves to my cluster on the internet, I can easily use <a href=https://cert-manager.io/docs/>cert-manager</a> to get a certificate from LetsEncrypt.</p><p>After all of that, I can access <code>grafana.joshcorp.co</code> outside of my network while authenticating using <a href=https://www.joshkasuboski.com>www.joshkasuboski.com</a>.</p><h2 id=whats-next>What's Next</h2><p>I'm pretty happy with the current state. My next move will be making sure everything is tracked in git and can be reproduced. From there I can start deploying.</p></section><footer><a class="permalink u-url" href=https://www.joshkasuboski.com/posts/home-k8s-raspberry-update/>ðŸ”—</a></footer></article></div><div class=h-card><img class=u-photo src=https://www.joshkasuboski.com/img/josh-scotland.jpg><div class=card-content><h2 class=card-name><a class="p-name u-url" href=https://www.joshkasuboski.com/ rel=me>Josh Kasuboski</a></h2><p class=card-subhead><span class=p-locality>Austin</span>,
<span class=p-country-name>United States</span><br><a class=u-email href=mailto:josh.kasuboski@gmail.com>Email me</a></p></div><p class=p-note>Josh Kasuboski is currently interested in developer productivity. He works to make it easier for a developer to take code from laptop to production.</p></div><div id=footer><nav id=article-skip><div class=next><p>&nbsp;</p></div><div class=top><a alt="Top of page" href=#>Top</a></div><div class=prev><a alt="Older article" href=https://www.joshkasuboski.com/posts/home-k8s-raspberry-pi/>Older &rarr;</a></div></nav><aside id=social><div id=social-icons><div class=icon-24x24><a class=glyph alt="Email me" href=mailto:josh.kasuboski@gmail.com><img src=https://www.joshkasuboski.com/icons/envelope.svg height=24px width=24px></a></div><div class=icon-24x24><a class=glyph alt="GitHub profile" href=https://github.com/kasuboski><img src=https://www.joshkasuboski.com/icons/github.svg height=24px width=24px></a></div><div class=icon-24x24><a class=glyph alt="LinkedIn profile" href=https://www.linkedin.com/in/joshkasuboski><img src=https://www.joshkasuboski.com/icons/linkedin.svg height=24px width=24px></a></div></div></aside><p class=copyright>Copyright Â© 2020, Josh Kasuboski</p></div></body></html>