<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Homelab Raspberry Pi Kubernetes Cluster Current State | Josh Kasuboski</title><meta name=description content="The k3s cluster is alive and well"><meta name=author content><link rel=me href=mailto:josh.kasuboski@gmail.com><link rel=me href=https://github.com/kasuboski><link data-proofer-ignore rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link data-proofer-ignore rel=microsub href=https://microsub.joshcorp.co/microsub><link rel=alternate type=application/rss+xml href=https://www.joshkasuboski.com/index.xml><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://unpkg.com/turretcss/dist/turretcss.min.css crossorigin=anonymous><style>@media only screen and (min-width:768px){:root{font-size:18px}}body{background-color:#faf9fa}pre{background-color:#d4f2e1}a{text-decoration-color:#5965f9}#site-header{box-shadow:0 4px 12px 0 rgba(0,0,0,.05)}#intro{background-color:#e6e8fe}#social a{color:transparent;text-decoration:none}</style></head><body><div class=padding-bottom-s><header id=site-header><div class="container max-width-l flex-justify-center padding-vertical-xs"><h1 class=no-margin-bottom><a class="text-decoration-none flex align-items-center" href=https://www.joshkasuboski.com/><img alt="jk logo" class="icon-s margin-right-xs" src=https://www.joshkasuboski.com/images/jk-logo.svg><small>Josh Kasuboski</small></a></h1><nav class=nav-inline><ul><li><a href=/about/>About</a></li><li><a href=/now/>Now</a></li></ul></nav></div></header><main class="container max-width-l margin-top-l"><article class=h-entry><header><h1 class="display-title-xl no-margin-bottom post-title p-name">Homelab Raspberry Pi Kubernetes Cluster Current State</h1><p class="post-date no-margin-top">Posted on
<time class=dt-published datetime=2020-05-10T12:20:48-05:00>10 May, 2020</time> by <a href=https://www.joshkasuboski.com/ class="p-author h-card" rel=author>Josh Kasuboski</a> Â· 2min read</p></header><section class="content e-content margin-top-l"><p>The cluster is alive and well and exposed to the internet ðŸ˜±</p><p>In a previous <a href=https://www.joshkasuboski.com/posts/home-k8s-raspberry-pi/>post</a>, I put out my plan for the cluster. I mostly followed along, but did end up getting <a href=https://www.amazon.com/gp/product/B00A128S24>this</a> switch and <a href=https://www.amazon.com/gp/product/B003L1AET2>these</a> ethernet cables.</p><p>I ended up with this set-up which is described in more detail below.</p><figure><a href=traffic-diagram.png><img src=traffic-diagram.png alt="Traffic Diagram"></a></figure><h2 id=hardware-and-monitoring>Hardware and Monitoring</h2><p>The cluster is set up with Raspbian Lite on 3 Raspberry Pi 4 4gb boards. Raspbian Lite seems to not support 64bit (yet) so I may be changing the operating system. The cluster has the monitoring stack from carlosedp's <a href=https://github.com/carlosedp/cluster-monitoring>repo</a>. I changed some things (mainly the ingress) in my forked <a href=https://github.com/kasuboski/cluster-monitoring>repo</a>.</p><p>This deploys some nice Grafana dashboards to see the state of the cluster as seen below. <code>blueberry</code> is the master node so hovers around 768m cpu cores and 1285Mi memory usage.</p><figure><a href=cluster-metrics.png><img src=cluster-metrics.png alt="Cluster Metrics"></a></figure><h2 id=ingress>Ingress</h2><p>This dashboard is exposed outside the cluster using <a href=https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#over-a-nodeport-service>ingress-nginx</a> with NodePorts. These nodeports are load balanced by an haproxy running in a container on my existing Raspberry Pi 3B+. This is a single point of failure for ingress ðŸ˜°, but should be good enough for now.</p><p>The Ingress is secured using <a href=https://github.com/vouch/vouch-proxy>vouch-proxy</a> with the ingress-nginx auth <a href=https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/>annotations</a>. It uses the <a href=https://indieauth.net/>IndieAuth</a> backend so I can login using this site as an identity.</p><h2 id=expose-to-the-world>Expose to the world</h2><p>The final piece of the puzzle to expose cluster services to the internet is a Linode <a href=https://www.linode.com/products/nanodes/>nanode</a>. I chose Linode largely because I had a credit&mldr; It's really just providing a public ip address that can forward to my network. I didn't set up port forwarding to my network instead the haproxy Raspberry Pi and the Linode VM are running <a href=https://tailscale.com/>tailscale</a>.</p><p>Tailscale allows the nanode to connect to my Raspberry Pi with a WireGuard connection through my crazy NAT situation. The nanode is also running an haproxy on ports 80 and 443 on the public ip interface and then proxying that to the tailscale ip of the Raspberry Pi.</p><p>I changed the DNS of <code>*.joshcorp.co</code> to point to the nanode. Now that <code>*.joshcorp.co</code> resolves to my cluster on the internet, I can easily use <a href=https://cert-manager.io/docs/>cert-manager</a> to get a certificate from LetsEncrypt.</p><p>After all of that, I can access <code>grafana.joshcorp.co</code> outside of my network while authenticating using <a href=https://www.joshkasuboski.com>www.joshkasuboski.com</a>.</p><h2 id=whats-next>What's Next</h2><p>I'm pretty happy with the current state. My next move will be making sure everything is tracked in git and can be reproduced. From there I can start deploying.</p></section><footer class=margin-top-m><a class="permalink u-url text-decoration-none" href=https://www.joshkasuboski.com/posts/home-k8s-raspberry-update/>ðŸ”—</a></footer></article><nav class="margin-top-l flex justify-content-space-around"><div><a alt="Newer article" href=https://www.joshkasuboski.com/posts/build-multiarch-image/>&larr; Building Multiarch Images</a></div><div class=show-s-up><a data-proofer-ignore alt="Top of page" href=#>Top</a></div><div><a alt="Older article" href=https://www.joshkasuboski.com/posts/home-k8s-raspberry-pi/>Homelab Raspberry Pi Kubernetes Cluster &rarr;</a></div></nav></main><footer class="container max-width-l margin-top-xl"><div class=margin-bottom-m><h4>Get more of my thoughts in an email newsletter!</h4><form action=https://buttondown.email/api/emails/embed-subscribe/kasuboski method=post target=popupwindow onsubmit="window.open('https://buttondown.email/kasuboski','popupwindow')" class=embeddable-buttondown-form><label for=bd-email>Your Email</label>
<input type=email name=email id=bd-email placeholder=me@email.com></input>
<input type=hidden value=1 name=embed></input>
<button class="button button-primary button-border" type=submit value=Subscribe>Subscribe</button><p class=font-size-s><a href=https://buttondown.email target=_blank>Powered by Buttondown.</a></p></form></div><div class="box-shadow-l padding-m"><div class="h-card flex align-content-center"><figure class=icon-xxl><img alt="profile photo" class=u-photo src=https://www.joshkasuboski.com/img/josh-scotland.jpg></figure><div class=margin-left-m><h3 class=display-title><a class="u-url p-name text-decoration-none" href=https://www.joshkasuboski.com/>Josh Kasuboski</a></h3><p>Living in Austin <img class=icon-xs style=vertical-align:middle alt=texas src=https://www.joshkasuboski.com/img/tx-fill.png> from <img class=icon-xs style=vertical-align:middle alt=wisconsin src=https://www.joshkasuboski.com/img/wi-fill.png></p><p id=social><a rel=me class="u-url margin-right-xs" href=https://github.com/kasuboski><img class=icon-xs src=https://www.joshkasuboski.com/icons/github.svg alt=github></a>
<a class=margin-right-xs href=https://linkedin.com/in/joshkasuboski/><img class=icon-xs src=https://www.joshkasuboski.com/icons/linkedin.svg alt=linkedin></a>
<a href=mailto:josh.kasuboski@gmail.com class="u-email margin-right-xxs" rel=me><img class=icon-xs src=https://www.joshkasuboski.com/icons/envelope.svg alt=email></a>
<button class="button button-icon button-xs" style=background-color:transparent;padding:0;border:0 id=checkout-button-beermoney role=link type=button>
<img class=icon-xs src=https://www.joshkasuboski.com/icons/beer-money-icon.svg alt=beermoney></button></p></div></div></div></footer></div><script async src="https://cdn.panelbear.com/analytics.js?site=FK681rNQuKp"></script><script>window.panelbear=window.panelbear||function(){window.panelbearQ=window.panelbearQ||[];panelbearQ.push(arguments);};panelbear('config',{site:'FK681rNQuKp'});</script><script src=https://js.stripe.com/v3></script><script>(function(){var DOMAIN='https://www.joshkasuboski.com/';var key='pk_live_51HJtKkASjDZJS9C9Ja9g6zTFbaTEdW7uCK2OTK1dq741RisoSBtSIac1QEMphVCEEkA7hTeuopkUsajAyWuyH7kT00cU4iVGfX';var price='price_1HJtUTASjDZJS9C90kJjztUq';var stripe=Stripe(key);var checkoutButton=document.getElementById('checkout-button-beermoney');checkoutButton.addEventListener('click',function(){stripe.redirectToCheckout({lineItems:[{price:price,quantity:1}],mode:'payment',successUrl:DOMAIN+'success',cancelUrl:DOMAIN+'canceled',}).then(function(result){if(result.error){var displayError=document.getElementById('error-message');displayError.textContent=result.error.message;}});});})();</script></body></html>