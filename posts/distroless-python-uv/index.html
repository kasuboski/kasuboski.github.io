<!doctype html><html lang=en-US><head><meta charset=utf-8><title>Building a Python Docker Image with Distroless and Uv | Josh Kasuboski</title>
<meta name=description content="Josh Kasuboski's personal site"><meta name=author content="Josh Kasuboski"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.joshkasuboski.com/img/josh-scotland-full.jpg"><meta name=twitter:title content="Building a Python Docker Image with Distroless and Uv"><meta name=twitter:description content="The images are too damn big! ðŸ“ˆ Letâ€™s use a sane project manager and build an image with minimal dependences."><meta property="og:url" content="https://www.joshkasuboski.com/posts/distroless-python-uv/"><meta property="og:site_name" content="Josh Kasuboski"><meta property="og:title" content="Building a Python Docker Image with Distroless and Uv"><meta property="og:description" content="The images are too damn big! ðŸ“ˆ Letâ€™s use a sane project manager and build an image with minimal dependences."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-08T13:03:13-06:00"><meta property="article:modified_time" content="2025-03-08T13:03:13-06:00"><meta property="og:image" content="https://www.joshkasuboski.com/img/josh-scotland-full.jpg"><link rel=me href=mailto:josh.kasuboski@gmail.com><link rel=me href=https://github.com/kasuboski><link data-proofer-ignore rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link data-proofer-ignore rel=microsub href=https://microsub.joshcorp.co/microsub><link rel=alternate type=application/rss+xml href=https://www.joshkasuboski.com/index.xml><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://unpkg.com/turretcss/dist/turretcss.min.css crossorigin=anonymous><style>@media only screen and (min-width:768px){:root{font-size:18px}}body{background-color:#faf9fa}pre{background-color:#d4f2e1}a{text-decoration-color:#5965f9}#site-header{box-shadow:0 4px 12px rgba(0,0,0,5%)}#intro{background-color:#e6e8fe}#social a{color:transparent;text-decoration:none}</style></head><body><div class=padding-bottom-s><header id=site-header><div class="container max-width-l flex-justify-center padding-vertical-xs"><h1 class=no-margin-bottom><a class="text-decoration-none flex align-items-center" href=https://www.joshkasuboski.com/><img alt="jk logo" class="icon-s margin-right-xs" src=https://www.joshkasuboski.com/images/jk-logo.svg><small>Josh Kasuboski</small></a></h1><nav class=nav-inline><ul><li><a href=/about/>About</a></li><li><a href=/now/>Now</a></li></ul></nav></div></header><main class="container max-width-l margin-top-l"><article class=h-entry><header><h1 class="display-title-xl no-margin-bottom post-title p-name">Building a Python Docker Image with Distroless and Uv</h1><p class="post-date no-margin-top">Posted on
<time class=dt-published datetime=2025-03-08T13:03:13-06:00>8 March, 2025
</time>by <a href=https://www.joshkasuboski.com/ class="p-author h-card" rel=author>Josh Kasuboski</a> Â· 4min read</p></header><section class="content e-content margin-top-l"><p>The images are too damn big! ðŸ“ˆ Let&rsquo;s use a sane project manager and build an image with minimal dependences.</p><h2 id=tooling>Tooling</h2><p>This will assume you use <a href=https://docs.astral.sh/uv/>uv</a> to manage your python project. It&rsquo;s really made me actually consider using python now&mldr; Uv has a pretty nice docker tutorial on GitHub that we&rsquo;re going to base off. You can find that <a href=https://github.com/astral-sh/uv-docker-example>here</a>.</p><p>It&rsquo;s an example fastapi project that returns <code>hello world</code>.</p><h2 id=whats-different>What&rsquo;s different?</h2><p>Their example includes a standalone multi-stage build that is pretty good. The standalone aspect comes from allowing uv to install their version of python that will match your project. The multi-stage build ensures you end up with a base debian image with just python and your app.</p><p>I wanted to not include the source code of the app separately since it&rsquo;ll be in the virtualenv anyway as well as get rid of debian.</p><p>So we&rsquo;ll base on a google distroless image.</p><h2 id=breaking-down-the-dockerfile>Breaking down the Dockerfile</h2><p>If you&rsquo;re impatient you can just read the Dockerfile. The first new thing is the builder is installing its own version of python. There are two environment variables that tell uv to only use the version of python that is managed by uv.</p><p><code>UV_PYTHON_INSTALL_DIR</code> is the directory where the python version will be installed and <code>UV_PYTHON_PREFERENCE</code> tells uv to only use the version of python that is managed by uv.</p><p>It then actually installs python. After we get python, we can install the project dependencies. Uv can install only the dependencies with <code>--no-install-project</code>. It only needs the lock file and <code>pyproject.toml</code> for this. Installing the dependencies separately ensures better caching since you probably don&rsquo;t change dependencies as much as the code.</p><p>After dependencies, we can copy the app and install the rest. Using <code>--no-editable</code> tells uv to not install the project with any dependency on the source code. Then our final image can be created from just the virtualenv.</p><p>The final runtime image is <code>gcr.io/distroless/cc</code>. This is a google <a href="https://github.com/GoogleContainerTools/distroless?tab=readme-ov-file">distroless</a> image that&rsquo;s a little smaller than <code>debian:slim</code>. Some of your python dependencies might still expect glibc at runtime so we use <code>cc</code> vs a <code>static</code> option.</p><p>The only thing we need then is to copy the python we installed with uv and the virtualenv. Adding the virtualenv path lets us reference any of the tools like fastapi.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> ghcr.io/astral-sh/uv:bookworm-slim AS builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> UV_COMPILE_BYTECODE<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> UV_LINK_MODE<span style=color:#f92672>=</span>copy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Configure the Python directory so it is consistent</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> UV_PYTHON_INSTALL_DIR<span style=color:#f92672>=</span>/python<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Only use the managed Python version</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> UV_PYTHON_PREFERENCE<span style=color:#f92672>=</span>only-managed<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Install Python before the project for caching</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> uv python install 3.12<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>cache,target<span style=color:#f92672>=</span>/root/.cache/uv <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>bind,source<span style=color:#f92672>=</span>uv.lock,target<span style=color:#f92672>=</span>uv.lock <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>bind,source<span style=color:#f92672>=</span>pyproject.toml,target<span style=color:#f92672>=</span>pyproject.toml <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    uv sync --frozen --no-install-project --no-dev --no-editable<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> . /app<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> --mount<span style=color:#f92672>=</span>type<span style=color:#f92672>=</span>cache,target<span style=color:#f92672>=</span>/root/.cache/uv <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    uv sync --frozen --no-dev --no-editable<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Then, use a final image without uv</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> gcr.io/distroless/cc</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Copy the Python version</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder --chown<span style=color:#f92672>=</span>python:python /python /python<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> /app</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Copy the application from the builder</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> --from<span style=color:#f92672>=</span>builder --chown<span style=color:#f92672>=</span>app:app /app/.venv /app/.venv<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Place executables in the environment at the front of the path</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>ENV</span> PATH<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;/app/.venv/bin:</span>$PATH<span style=color:#e6db74>&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Run the FastAPI application by default</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;fastapi&#34;</span>, <span style=color:#e6db74>&#34;run&#34;</span>, <span style=color:#e6db74>&#34;--host&#34;</span>, <span style=color:#e6db74>&#34;0.0.0.0&#34;</span>, <span style=color:#e6db74>&#34;/app/.venv/lib/python3.12/site-packages/uv_docker_example&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><h2 id=but-why>But why?</h2><p>Making the smallest image can help with startup time as you need to download and load less before you get to your app. For me, the biggest reason to go for a smaller image though is to reduce the vulnerability surface. You can&rsquo;t have vulnerabilities if there&rsquo;s nothing to be vulnerable.</p><p>Python isn&rsquo;t super conducive to an ultra minimal image. The python interpreter is around 75MB with our virtualenv being around 55MB. The smallest image we could hope for is then 130MB. The distroless base is 23.5 MB so it&rsquo;s quite a fraction of overall size.</p><p>The <code>debian:bookworm-slim</code> image is around 75MB. It also includes things like bash which can be nice for debugging, but also for vulnerabilities.</p><p>It is worth noting, when I was doing this, <code>debian:bookworm-slim</code> had no vulnerabilities reported by <code>trivy</code>. The base images are generally kept up to date to patch vulnerabilities, but more vulnerabilities are found because of their nature. If you are rebasing your images often it may not matter to you.</p><p>I previously explored continously scanning using <a href=https://www.joshkasuboski.com/posts/image-scanning-trivy/><code>trivy</code></a> in a separate post using github actions.</p></section><footer class=margin-top-m><a class="permalink u-url text-decoration-none" href=https://www.joshkasuboski.com/posts/distroless-python-uv/>ðŸ”—</a></footer></article><nav class="margin-top-l flex justify-content-space-around"><div></div><div class=show-s-up><a data-proofer-ignore alt="Top of page" href=#>Top</a></div><div><a alt="Older article" href=https://www.joshkasuboski.com/posts/talos-cluster/>Talos Cluster &rarr;</a></div></nav></main><footer class="container max-width-l margin-top-xl"><div class=margin-bottom-m><h4>Get more of my thoughts in an email newsletter!</h4><form action=https://buttondown.email/api/emails/embed-subscribe/kasuboski method=post target=popupwindow onsubmit='window.open("https://buttondown.email/kasuboski","popupwindow")' class=embeddable-buttondown-form><label for=bd-email>Your Email</label>
<input type=email name=email id=bd-email placeholder=me@email.com></input>
<input type=hidden value=1 name=embed></input>
<button class="button button-primary button-border" type=submit value=Subscribe>Subscribe</button><p class=font-size-s><a href=https://buttondown.email target=_blank>Powered by Buttondown.</a></p></form></div><div class="box-shadow-l padding-m"><div class="h-card flex align-content-center"><figure class=icon-xxl><img alt="profile photo" class=u-photo src=https://www.joshkasuboski.com/img/josh-scotland.jpg></figure><div class=margin-left-m><h3 class=display-title><a class="u-url p-name text-decoration-none" href=https://www.joshkasuboski.com/>Josh Kasuboski</a></h3><p>Living in Austin <img class=icon-xs style=vertical-align:middle alt=texas src=https://www.joshkasuboski.com/img/tx-fill.png> from <img class=icon-xs style=vertical-align:middle alt=wisconsin src=https://www.joshkasuboski.com/img/wi-fill.png></p><p id=social><a rel=me class="u-url margin-right-xs" href=https://github.com/kasuboski><img class=icon-xs src=https://www.joshkasuboski.com/icons/github.svg alt=github>
</a><a class=margin-right-xs href=https://linkedin.com/in/joshkasuboski/><img class=icon-xs src=https://www.joshkasuboski.com/icons/linkedin.svg alt=linkedin>
</a><a href=mailto:josh.kasuboski@gmail.com class="u-email margin-right-xxs" rel=me><img class=icon-xs src=https://www.joshkasuboski.com/icons/envelope.svg alt=email>
</a><a href=https://www.joshkasuboski.com/payments/><img class=icon-xs src=https://www.joshkasuboski.com/icons/beer-money-icon.svg alt=beermoney></a></p></div></div></div></footer></div><script async src=https://rum.cronitor.io/script.js></script><script>window.cronitor=window.cronitor||function(){(window.cronitor.q=window.cronitor.q||[]).push(arguments)},cronitor("config",{clientKey:"b2a9cb0f440d559169438f89c882dddb"})</script></body></html>