<!doctype html><html lang=en-US><head><meta charset=utf-8><title>Re-provisioning the Cluster | Josh Kasuboski</title>
<meta name=description content="Josh Kasuboski's personal site"><meta name=author content="Josh Kasuboski"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.joshkasuboski.com/img/josh-scotland-full.jpg"><meta name=twitter:title content="Re-provisioning the Cluster"><meta name=twitter:description content="The SD card died in the server node of my cluster üò¢. Time to start again."><meta property="og:url" content="https://www.joshkasuboski.com/posts/cluster-reprovisioning/"><meta property="og:site_name" content="Josh Kasuboski"><meta property="og:title" content="Re-provisioning the Cluster"><meta property="og:description" content="The SD card died in the server node of my cluster üò¢. Time to start again."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-15T12:29:47-06:00"><meta property="article:modified_time" content="2020-12-15T12:29:47-06:00"><meta property="og:image" content="https://www.joshkasuboski.com/img/josh-scotland-full.jpg"><link rel=me href=mailto:josh.kasuboski@gmail.com><link rel=me href=https://github.com/kasuboski><link data-proofer-ignore rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link data-proofer-ignore rel=microsub href=https://microsub.joshcorp.co/microsub><link rel=alternate type=application/rss+xml href=https://www.joshkasuboski.com/index.xml><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://unpkg.com/turretcss/dist/turretcss.min.css crossorigin=anonymous><style>@media only screen and (min-width:768px){:root{font-size:18px}}body{background-color:#faf9fa}pre{background-color:#d4f2e1}a{text-decoration-color:#5965f9}#site-header{box-shadow:0 4px 12px rgba(0,0,0,5%)}#intro{background-color:#e6e8fe}#social a{color:transparent;text-decoration:none}</style></head><body><div class=padding-bottom-s><header id=site-header><div class="container max-width-l flex-justify-center padding-vertical-xs"><h1 class=no-margin-bottom><a class="text-decoration-none flex align-items-center" href=https://www.joshkasuboski.com/><img alt="jk logo" class="icon-s margin-right-xs" src=https://www.joshkasuboski.com/images/jk-logo.svg><small>Josh Kasuboski</small></a></h1><nav class=nav-inline><ul><li><a href=/about/>About</a></li><li><a href=/now/>Now</a></li></ul></nav></div></header><main class="container max-width-l margin-top-l"><article class=h-entry><header><h1 class="display-title-xl no-margin-bottom post-title p-name">Re-provisioning the Cluster</h1><p class="post-date no-margin-top">Posted on
<time class=dt-published datetime=2020-12-15T12:29:47-06:00>15 December, 2020
</time>by <a href=https://www.joshkasuboski.com/ class="p-author h-card" rel=author>Josh Kasuboski</a> ¬∑ 2min read</p></header><section class="content e-content margin-top-l"><p>The SD card died in the server node of my cluster üò¢. Time to start again.</p><h2 id=tragedy>Tragedy</h2><p>The SD card in blueberry died taking down the kubernetes api with it. The workloads were still running so it didn&rsquo;t matter too much, but I couldn&rsquo;t do anything new.</p><p>I didn&rsquo;t have a backup for the SD card&mldr; so was going to have to start again. I took the opportunity to try out some new things. I had been wanting to try out Ubuntu on the Raspberry Pi since they recently announced official support.</p><p>My thought with Ubuntu is to standardize more on the various machines I run. Previously, Raspbian had to have its own process for all automations.</p><h2 id=re-provisioning>Re-provisioning</h2><p>After deciding to go with Ubuntu, I needed to flash the sd cards with ubuntu and reinstall k3s. I used a pre-installed image of Ubuntu so was able to have them boot headlessly using cloud-init.</p><p>After flashing, I could edit the cloud-init files so the pi would come up with the correct hostname and my ssh keys. I used this <a href=https://github.com/billimek/homelab-infrastructure/tree/master/k3s/arm64>repo</a> from <a href=https://github.com/billimek>billimek</a>.</p><h2 id=installing-k3s>Installing k3s</h2><p>I decided to install <a href=https://docs.cilium.io/en/v1.9/gettingstarted/k3s/>cilium</a> as the cni instead of the bundled flannel. I initially wanted to use the multi-cluster features of cilium, but that seems to require running etcd separately&mldr; so I will have to figure out if that&rsquo;s worth running on the Raspberry Pis. I was able to use the Hubble UI to have real-time telemetry info. In the future, I want to use the Cilium cluster-wide network policies.</p><p>Cilium on k3s requires disabling the built-in flannel. I had to use the deprecated <code>--no-flannel</code> since <code>--flannel-backend=none</code> didn&rsquo;t seem to be supported. I also had to manually install the loopback cni plugin from <a href=https://github.com/containernetworking/plugins>containernetworking/plugins</a>.</p><h2 id=next-steps->Next Steps ü¶∂</h2><p>I started making a new <code>home-infra</code> repo where I&rsquo;ll start putting the steps (hopefully automated). Currently, just doing everything manually wasn&rsquo;t all that bad. Getting the stateless workloads running again was basically reinstalling ArgoCD and then pointing it at my gitops <a href=https://github.com/kasuboski/k8s-gitops>repo</a>.</p><p>One thing that was a little troublesome is remembering to label the node corresponding to the fast and slow storage. It was nice that my workloads requiring storage did land on the same node again, but it would be better for this to happen automatically. OpenEBS could probably help with this using the automatic detection of block devices and then letting you map that to storage classes.</p><p>Manually setting up the folders for the <a href=https://github.com/rancher/local-path-provisioner>local-path-provisioner</a> is pretty convenient though. I could probably just use <a href=https://kubernetes.io/blog/2019/04/04/kubernetes-1.14-local-persistent-volumes-ga/>local persistent volumes as well</a> ü§∑‚Äç‚ôÇÔ∏è.</p></section><footer class=margin-top-m><a class="permalink u-url text-decoration-none" href=https://www.joshkasuboski.com/posts/cluster-reprovisioning/>üîó</a></footer></article><nav class="margin-top-l flex justify-content-space-around"><div><a alt="Newer article" href=https://www.joshkasuboski.com/posts/rackmount-pi/>&larr; Rackmounting the Raspberry PIs</a></div><div class=show-s-up><a data-proofer-ignore alt="Top of page" href=#>Top</a></div><div><a alt="Older article" href=https://www.joshkasuboski.com/posts/removing-openebs/>Removing OpenEBS &rarr;</a></div></nav></main><footer class="container max-width-l margin-top-xl"><div class=margin-bottom-m><h4>Get more of my thoughts in an email newsletter!</h4><form action=https://buttondown.email/api/emails/embed-subscribe/kasuboski method=post target=popupwindow onsubmit='window.open("https://buttondown.email/kasuboski","popupwindow")' class=embeddable-buttondown-form><label for=bd-email>Your Email</label>
<input type=email name=email id=bd-email placeholder=me@email.com></input>
<input type=hidden value=1 name=embed></input>
<button class="button button-primary button-border" type=submit value=Subscribe>Subscribe</button><p class=font-size-s><a href=https://buttondown.email target=_blank>Powered by Buttondown.</a></p></form></div><div class="box-shadow-l padding-m"><div class="h-card flex align-content-center"><figure class=icon-xxl><img alt="profile photo" class=u-photo src=https://www.joshkasuboski.com/img/josh-scotland.jpg></figure><div class=margin-left-m><h3 class=display-title><a class="u-url p-name text-decoration-none" href=https://www.joshkasuboski.com/>Josh Kasuboski</a></h3><p>Living in Austin <img class=icon-xs style=vertical-align:middle alt=texas src=https://www.joshkasuboski.com/img/tx-fill.png> from <img class=icon-xs style=vertical-align:middle alt=wisconsin src=https://www.joshkasuboski.com/img/wi-fill.png></p><p id=social><a rel=me class="u-url margin-right-xs" href=https://github.com/kasuboski><img class=icon-xs src=https://www.joshkasuboski.com/icons/github.svg alt=github>
</a><a class=margin-right-xs href=https://linkedin.com/in/joshkasuboski/><img class=icon-xs src=https://www.joshkasuboski.com/icons/linkedin.svg alt=linkedin>
</a><a href=mailto:josh.kasuboski@gmail.com class="u-email margin-right-xxs" rel=me><img class=icon-xs src=https://www.joshkasuboski.com/icons/envelope.svg alt=email>
</a><a href=https://www.joshkasuboski.com/payments/><img class=icon-xs src=https://www.joshkasuboski.com/icons/beer-money-icon.svg alt=beermoney></a></p></div></div></div></footer></div><script async src=https://rum.cronitor.io/script.js></script><script>window.cronitor=window.cronitor||function(){(window.cronitor.q=window.cronitor.q||[]).push(arguments)},cronitor("config",{clientKey:"b2a9cb0f440d559169438f89c882dddb"})</script></body></html>