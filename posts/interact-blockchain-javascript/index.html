<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Interact with Blockchain Apps in Javascript | Josh Kasuboski</title><meta name=description content="Josh Kasuboski's personal site"><meta name=author content="Josh Kasuboski"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.joshkasuboski.com/img/josh-scotland-full.jpg"><meta name=twitter:title content="Interact with Blockchain Apps in Javascript"><meta name=twitter:description content="Interfacing with a blockchain can seem intimidating, but this dapp has a nice javascript sdk."><meta property="og:title" content="Interact with Blockchain Apps in Javascript"><meta property="og:description" content="Interfacing with a blockchain can seem intimidating, but this dapp has a nice javascript sdk."><meta property="og:type" content="article"><meta property="og:url" content="https://www.joshkasuboski.com/posts/interact-blockchain-javascript/"><meta property="og:image" content="https://www.joshkasuboski.com/img/josh-scotland-full.jpg"><meta property="article:published_time" content="2021-08-30T21:11:59-05:00"><meta property="article:modified_time" content="2021-08-30T21:11:59-05:00"><link rel=me href=mailto:josh.kasuboski@gmail.com><link rel=me href=https://github.com/kasuboski><link data-proofer-ignore rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link data-proofer-ignore rel=microsub href=https://microsub.joshcorp.co/microsub><link rel=alternate type=application/rss+xml href=https://www.joshkasuboski.com/index.xml><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://unpkg.com/turretcss/dist/turretcss.min.css crossorigin=anonymous><style>@media only screen and (min-width:768px){:root{font-size:18px}}body{background-color:#faf9fa}pre{background-color:#d4f2e1}a{text-decoration-color:#5965f9}#site-header{box-shadow:0 4px 12px 0 rgba(0,0,0,.05)}#intro{background-color:#e6e8fe}#social a{color:transparent;text-decoration:none}</style></head><body><div class=padding-bottom-s><header id=site-header><div class="container max-width-l flex-justify-center padding-vertical-xs"><h1 class=no-margin-bottom><a class="text-decoration-none flex align-items-center" href=https://www.joshkasuboski.com/><img alt="jk logo" class="icon-s margin-right-xs" src=https://www.joshkasuboski.com/images/jk-logo.svg><small>Josh Kasuboski</small></a></h1><nav class=nav-inline><ul><li><a href=/about/>About</a></li><li><a href=/now/>Now</a></li></ul></nav></div></header><main class="container max-width-l margin-top-l"><article class=h-entry><header><h1 class="display-title-xl no-margin-bottom post-title p-name">Interact with Blockchain Apps in Javascript</h1><p class="post-date no-margin-top">Posted on
<time class=dt-published datetime=2021-08-30T21:11:59-05:00>30 August, 2021</time> by <a href=https://www.joshkasuboski.com/ class="p-author h-card" rel=author>Josh Kasuboski</a> Â· 3min read</p></header><section class="content e-content margin-top-l"><p>Interfacing with a blockchain can seem intimidating, but this dapp has a nice javascript sdk.</p><h2 id=whats-it-do>What's it do?</h2><p>I made a script that will check your collateral positions in <a href=https://terra.mirror.finance/>Mirror Protocol</a>. Mirror is an app on the <a href=https://www.terra.money/>Terra</a> blockchain that lets you trade stocks, but in reality they are tokens that try to stay pegged to the real life equivalent.</p><p>There's an option to short an asset in Mirror. This requires that you put up collateral as you are essentially borrowing an asset and promise to pay it back later. The collateral you put up needs to maintain a certain ratio or it will be liquidated to pay your debt.</p><p>If the asset you borrowed grows in value too fast you may need to add more collateral or close your position to not get liquidated. You can imagine you might want to know if you're getting close, before it happens, and while not checking constantly.</p><h2 id=interacting-with-mirror>Interacting with Mirror</h2><p>Mirror provides a Javascript SDK at <a href=https://docs.mirror.finance/developer-tools/mirror.js>Mirror.js</a>. The documentation is a little lacking, but between reading the source code and the queries available on the actual <a href=https://docs.mirror.finance/contracts/mint#positions>smart contract</a> you can find everything you need.</p><p>Once you have this SDK, interacting with Mirror and Terra is pretty simple. The entire process of checking if your collateral ratio is safe is shown below.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#a6e22e>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>checkPositions</span>(<span style=color:#a6e22e>address</span>) {
  <span style=color:#75715e>// find positions
</span><span style=color:#75715e></span>  <span style=color:#75715e>// if short look up price asset vs collateral
</span><span style=color:#75715e></span>  <span style=color:#75715e>// check that collateral ratio is safe
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>positions</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>await</span> <span style=color:#a6e22e>mirror</span>.<span style=color:#a6e22e>mint</span>.<span style=color:#a6e22e>getPositions</span>(<span style=color:#a6e22e>address</span>);
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>short_positions</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>positions</span>.<span style=color:#a6e22e>positions</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>pos</span> =&gt; <span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>is_short</span>);
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>info</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>await</span> Promise.<span style=color:#a6e22e>all</span>(<span style=color:#a6e22e>short_positions</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>async</span> <span style=color:#a6e22e>pos</span> =&gt; {
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>collateralPrice</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>await</span> <span style=color:#a6e22e>getCollateralPrice</span>(<span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>collateral</span>.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>contract_addr</span>);
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>assetPrice</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>await</span> <span style=color:#a6e22e>getAssetPrice</span>(<span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>asset</span>.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>contract_addr</span>);

    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>collateralAmount</span> <span style=color:#f92672>=</span> Number.parseInt(<span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>collateral</span>.<span style=color:#a6e22e>amount</span>);
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>assetAmount</span> <span style=color:#f92672>=</span> Number.parseInt(<span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>asset</span>.<span style=color:#a6e22e>amount</span>);

    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>collateralValue</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>collateralAmount</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>collateralPrice</span>;
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>assetValue</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>assetAmount</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>assetPrice</span>;

    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>collateralRatio</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>collateralValue</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>assetValue</span>;
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>minRatio</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>await</span> <span style=color:#a6e22e>getMinCollateralRatio</span>(<span style=color:#a6e22e>pos</span>.<span style=color:#a6e22e>asset</span>.<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>token</span>.<span style=color:#a6e22e>contract_addr</span>);
    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>safeRatio</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>minRatio</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.5</span>; <span style=color:#75715e>// taken from mirror site
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isSafe</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>collateralRatio</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>safeRatio</span>;

    <span style=color:#66d9ef>return</span> {
      <span style=color:#a6e22e>collateralPrice</span>,
      <span style=color:#a6e22e>assetPrice</span>,
      <span style=color:#a6e22e>collateralAmount</span>,
      <span style=color:#a6e22e>assetAmount</span>,
      <span style=color:#a6e22e>collateralValue</span>, 
      <span style=color:#a6e22e>assetValue</span>,
      <span style=color:#a6e22e>collateralRatio</span>,
      <span style=color:#a6e22e>isSafe</span>,
    };
  }));

  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>info</span>;
}
</code></pre></div><p>All of the information we need has mappings in Javascript so it feels like calling a function. If there's anything not exposed there is also a GraphQL API. If you want to try it out you can find it on GitHub at <a href=https://github.com/kasuboski/mirror-watch>kasuboski/mirror-watch</a>. You just need to know a Terra address. It can be yours or someone else's since all data is public.</p><h2 id=moving-forward>Moving Forward</h2><p>I already made a similar script for <a href=https://anchorprotocol.com/>Anchor Protocol</a>, which is also on Terra, at <a href=https://github.com/kasuboski/anchor-watch>kasuboski/anchor-watch</a>. There are already projects building notifications and auto repayment strategies. There are also projects that are trying to combine Mirror Assets to make a pseudo ETF.</p><p>I started messing with <a href=https://academy.terra.money>Terra Academy</a>, where it walks you through building a smart contract in Rust. Maybe I'll end up doing something with that, but for now it's easy enough to interface just using the various APIs. No need to live on-chain.</p></section><footer class=margin-top-m><a class="permalink u-url text-decoration-none" href=https://www.joshkasuboski.com/posts/interact-blockchain-javascript/>ð</a></footer></article><nav class="margin-top-l flex justify-content-space-around"><div><a alt="Newer article" href=https://www.joshkasuboski.com/posts/multi-region-k3s/>&larr; Multi-Region K3s</a></div><div class=show-s-up><a data-proofer-ignore alt="Top of page" href=#>Top</a></div><div><a alt="Older article" href=https://www.joshkasuboski.com/posts/moving-cluster-to-the-cloud/>Moving My Cluster to the Cloud &rarr;</a></div></nav></main><footer class="container max-width-l margin-top-xl"><div class=margin-bottom-m><h4>Get more of my thoughts in an email newsletter!</h4><form action=https://buttondown.email/api/emails/embed-subscribe/kasuboski method=post target=popupwindow onsubmit="window.open('https://buttondown.email/kasuboski','popupwindow')" class=embeddable-buttondown-form><label for=bd-email>Your Email</label>
<input type=email name=email id=bd-email placeholder=me@email.com></input>
<input type=hidden value=1 name=embed></input>
<button class="button button-primary button-border" type=submit value=Subscribe>Subscribe</button><p class=font-size-s><a href=https://buttondown.email target=_blank>Powered by Buttondown.</a></p></form></div><div class="box-shadow-l padding-m"><div class="h-card flex align-content-center"><figure class=icon-xxl><img alt="profile photo" class=u-photo src=https://www.joshkasuboski.com/img/josh-scotland.jpg></figure><div class=margin-left-m><h3 class=display-title><a class="u-url p-name text-decoration-none" href=https://www.joshkasuboski.com/>Josh Kasuboski</a></h3><p>Living in Austin <img class=icon-xs style=vertical-align:middle alt=texas src=https://www.joshkasuboski.com/img/tx-fill.png> from <img class=icon-xs style=vertical-align:middle alt=wisconsin src=https://www.joshkasuboski.com/img/wi-fill.png></p><p id=social><a rel=me class="u-url margin-right-xs" href=https://github.com/kasuboski><img class=icon-xs src=https://www.joshkasuboski.com/icons/github.svg alt=github></a>
<a class=margin-right-xs href=https://linkedin.com/in/joshkasuboski/><img class=icon-xs src=https://www.joshkasuboski.com/icons/linkedin.svg alt=linkedin></a>
<a href=mailto:josh.kasuboski@gmail.com class="u-email margin-right-xxs" rel=me><img class=icon-xs src=https://www.joshkasuboski.com/icons/envelope.svg alt=email></a>
<a href=https://www.joshkasuboski.com/payments/><img class=icon-xs src=https://www.joshkasuboski.com/icons/beer-money-icon.svg alt=beermoney></a></p></div></div></div></footer></div><script async src="https://cdn.panelbear.com/analytics.js?site=FK681rNQuKp"></script><script>window.panelbear=window.panelbear||function(){window.panelbearQ=window.panelbearQ||[];panelbearQ.push(arguments);};panelbear('config',{site:'FK681rNQuKp'});</script></body></html>