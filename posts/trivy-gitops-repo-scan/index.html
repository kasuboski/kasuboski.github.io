<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Scan Images in my GitOps Repo | Josh Kasuboski</title><meta name=description content="Josh Kasuboski's personal site"><meta name=author content><link rel=me href=mailto:josh.kasuboski@gmail.com><link rel=me href=https://github.com/kasuboski><link data-proofer-ignore rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link data-proofer-ignore rel=microsub href=https://microsub.joshcorp.co/microsub><link rel=alternate type=application/rss+xml href=https://www.joshkasuboski.com/index.xml><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://unpkg.com/turretcss/dist/turretcss.min.css crossorigin=anonymous><style>@media only screen and (min-width:768px){:root{font-size:18px}}body{background-color:#faf9fa}pre{background-color:#d4f2e1}a{text-decoration-color:#5965f9}#site-header{box-shadow:0 4px 12px 0 rgba(0,0,0,.05)}#intro{background-color:#e6e8fe}#social a{color:transparent;text-decoration:none}</style></head><body><div class=padding-bottom-s><header id=site-header><div class="container max-width-l flex-justify-center padding-vertical-xs"><h1 class=no-margin-bottom><a class="text-decoration-none flex align-items-center" href=https://www.joshkasuboski.com/><img alt="jk logo" class="icon-s margin-right-xs" src=https://www.joshkasuboski.com/images/jk-logo.svg><small>Josh Kasuboski</small></a></h1><nav class=nav-inline><ul><li><a href=/about/>About</a></li><li><a href=/now/>Now</a></li></ul></nav></div></header><main class="container max-width-l margin-top-l"><article class=h-entry><header><h1 class="display-title-xl no-margin-bottom post-title p-name">Scan Images in my GitOps Repo</h1><p class="post-date no-margin-top">Posted on
<time class=dt-published datetime=2020-10-22T14:41:31-05:00>22 October, 2020</time> by <a href=https://www.joshkasuboski.com/ class="p-author h-card" rel=author>Josh Kasuboski</a> ¬∑ 2min read</p></header><section class="content e-content margin-top-l"><p>Scanning the container images deployed to my cluster used to be manual. Now it happens automatically every night. üê±‚Äçüèç</p><h2 id=how-to-scan>How to Scan</h2><p>I use Trivy to scan container images. I wrote about scanning my GitOps repo for images earlier <a href=https://www.joshkasuboski.com/posts/scan-images-in-files/>here</a>. Basically, there's a fancy grep that matches <code>image: (&lt;name>)</code> and that name is sent to Trivy.</p><p>My GitOps repo is on GitHub at <a href=https://github.com/kasuboski/k8s-gitops>kasuboski/k8s-gitops</a>. It seemed natural to run the scan periodically using GitHub Actions. The scan will happen on every push and every night.</p><p>I needed a way to exclude an image that wasn't able to scan on an x86 host. The one liner from my previous post needed a <code>grep -v</code> to exclude certain patterns.</p><h2 id=making-the-github-actions-workflow>Making the GitHub Actions Workflow</h2><p>I had a lot of trouble getting <code>ack</code> configured in a runner. I ended up making a docker image that downloads trivy, finds the images, and scans them.</p><p>This image has its own repo <a href=https://github.com/kasuboski/trivy-scan-dir>kasuboski/trivy-scan-dir</a>. If you just want to scan a repo you can run <code>docker run -it --rm -v /path/to/yaml:/gitops -e EXCLUDED='no/scan also/noscan' kasuboski/trivy-scan-dir</code>.</p><p>To run this in a workflow, add the below step.</p><pre><code>- name: Scan Images
  uses: docker://kasuboski/trivy-scan-dir:latest
  env:
    EXCLUDED: 'no/scan also/noscan'
</code></pre><p>My full workflow can be found in <a href=https://github.com/kasuboski/k8s-gitops/blob/master/.github/workflows/scan-images.yaml>kasuboski/k8s-gitops</a>. It triggers on <code>workflow_dispatch</code>, <code>cron</code>, and <code>push</code> to yaml files.</p><p>Workflow Dispatch lets you run the workflow manually from the GitHub Actions UI. This was really convenient for testing. The cron schedule runs every morning at 4:03am.</p><p><a href=manual-workflow-run.png><img src=manual-workflow-run.png alt="manual trigger"></a></p><h2 id=results>Results</h2><p>This workflow has alerted me to multiple vulnerabilities. If the workflow fails, I get an email and then can look into updating the image.</p><p>The results even look pretty decent in the GitHub app so I can tell which images I need to be worried about. An example failing run is shown below.</p><p><a href=failed-image-scan.png><img src=failed-image-scan.png alt="failed run"></a></p><p>I still want to add something in cluster to enforce only the images I want are running. Finding the images to scan also needs to be more robust. For instance, some images only show up once manifests are rendered.</p></section><footer class=margin-top-m><a class="permalink u-url text-decoration-none" href=https://www.joshkasuboski.com/posts/trivy-gitops-repo-scan/>üîó</a></footer></article><nav class="margin-top-l flex justify-content-space-around"><div><a alt="Newer article" href=https://www.joshkasuboski.com/posts/client-side-cart-1/>&larr; Client Side Shopping Cart</a></div><div class=show-s-up><a data-proofer-ignore alt="Top of page" href=#>Top</a></div><div><a alt="Older article" href=https://www.joshkasuboski.com/posts/stripe-beer-money/>Accept Beer Money with Stripe - Sans Server &rarr;</a></div></nav></main><footer class="container max-width-l margin-top-xl"><div class=margin-bottom-m><h4>Get more of my thoughts in an email newsletter!</h4><form action=https://buttondown.email/api/emails/embed-subscribe/kasuboski method=post target=popupwindow onsubmit="window.open('https://buttondown.email/kasuboski','popupwindow')" class=embeddable-buttondown-form><label for=bd-email>Your Email</label>
<input type=email name=email id=bd-email placeholder=me@email.com></input>
<input type=hidden value=1 name=embed></input>
<button class="button button-primary button-border" type=submit value=Subscribe>Subscribe</button><p class=font-size-s><a href=https://buttondown.email target=_blank>Powered by Buttondown.</a></p></form></div><div class="box-shadow-l padding-m"><div class="h-card flex align-content-center"><figure class=icon-xxl><img alt="profile photo" class=u-photo src=https://www.joshkasuboski.com/img/josh-scotland.jpg></figure><div class=margin-left-m><h3 class=display-title><a class="u-url p-name text-decoration-none" href=https://www.joshkasuboski.com/>Josh Kasuboski</a></h3><p>Living in Austin <img class=icon-xs style=vertical-align:middle alt=texas src=https://www.joshkasuboski.com/img/tx-fill.png> from <img class=icon-xs style=vertical-align:middle alt=wisconsin src=https://www.joshkasuboski.com/img/wi-fill.png></p><p id=social><a rel=me class="u-url margin-right-xs" href=https://github.com/kasuboski><img class=icon-xs src=https://www.joshkasuboski.com/icons/github.svg alt=github></a>
<a class=margin-right-xs href=https://linkedin.com/in/joshkasuboski/><img class=icon-xs src=https://www.joshkasuboski.com/icons/linkedin.svg alt=linkedin></a>
<a href=mailto:josh.kasuboski@gmail.com class="u-email margin-right-xxs" rel=me><img class=icon-xs src=https://www.joshkasuboski.com/icons/envelope.svg alt=email></a>
<button class="button button-icon button-xs" style=background-color:transparent;padding:0;border:0 id=checkout-button-beermoney role=link type=button>
<img class=icon-xs src=https://www.joshkasuboski.com/icons/beer-money-icon.svg alt=beermoney></button></p></div></div></div></footer></div><script async src="https://cdn.panelbear.com/analytics.js?site=FK681rNQuKp"></script><script>window.panelbear=window.panelbear||function(){window.panelbearQ=window.panelbearQ||[];panelbearQ.push(arguments);};panelbear('config',{site:'FK681rNQuKp'});</script><script src=https://js.stripe.com/v3></script><script>(function(){var DOMAIN='https://www.joshkasuboski.com/';var key='pk_live_51HJtKkASjDZJS9C9Ja9g6zTFbaTEdW7uCK2OTK1dq741RisoSBtSIac1QEMphVCEEkA7hTeuopkUsajAyWuyH7kT00cU4iVGfX';var price='price_1HJtUTASjDZJS9C90kJjztUq';var stripe=Stripe(key);var checkoutButton=document.getElementById('checkout-button-beermoney');checkoutButton.addEventListener('click',function(){stripe.redirectToCheckout({lineItems:[{price:price,quantity:1}],mode:'payment',successUrl:DOMAIN+'success',cancelUrl:DOMAIN+'canceled',}).then(function(result){if(result.error){var displayError=document.getElementById('error-message');displayError.textContent=result.error.message;}});});})();</script></body></html>