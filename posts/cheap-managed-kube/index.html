<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Cheap Managed Kubernetes with Terraform | Josh Kasuboski</title><meta name=description content="Deploying a cheap kubernetes cluster on GKE with Terraform"><meta name=author content><link rel=apple-touch-icon sizes=180x180 href=https://joshkasuboski.com/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://joshkasuboski.com/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://joshkasuboski.com/favicon-16x16.png><link rel=manifest href=https://joshkasuboski.com/site.webmanifest><link rel=mask-icon href=https://joshkasuboski.com/safari-pinned-tab.svg color=#00416a><meta name=msapplication-TileColor content="#00aba9"><meta name=theme-color content="#ffffff"><link rel=me href=mailto:josh.kasuboski@gmail.com><link rel=me href=https://github.com/kasuboski><link rel=authorization_endpoint href=https://indieauth.com/auth><link rel=stylesheet href=https://joshkasuboski.com/css/fonts.css><link rel=stylesheet href=https://joshkasuboski.com/css/style.css><meta name=viewport content="width=device-width,initial-scale=1"></head><body><div id=sitelogo><a class=glyph alt=Home href=https://joshkasuboski.com/><img src=https://joshkasuboski.com/images/site-logo.svg alt="Site Logo" height=64px width=64px></a></div><header><nav><div id=page-nav><div class=page-nav-item><a href=https://joshkasuboski.com/>Home</a></div><div class=page-nav-item><a href=/about/><span>About</span></a></div><div class=page-nav-item><a href=/now/><span>Now</span></a></div></div></nav></header><div id=content><article class=h-entry><header><h1 class="post-title p-name">Cheap Managed Kubernetes with Terraform</h1><p class=post-date>Posted on
<time class=dt-published datetime=2019-04-18T14:15:59-06:00>18 April, 2019 at 14:15 -0600</time> by <a href=https://joshkasuboski.com/ class="p-author h-card" rel=author>Josh</a></p></header><section class="content e-content"><p>Kubernetes is the way to deploy your services in a scalable and reliable way. However, it's a pretty complex system to manage yourself. Thankfully, cloud providers are offering managed versions where you only pay for the worker nodes.</p><p>We'll use <a href=https://cloud.google.com/kubernetes-engine/>GKE</a>, Google's managed kubernetes offering, to deploy a cluster so we can test out kubernetes.</p><p>We'll use <a href=https://www.terraform.io/>Terraform</a> to make sure we have a repeatable deployment process.</p><p>If you just want to skip to the code it's on <a href=https://github.com/kasuboski/cheap-managed-kubernetes>GitHub</a>.</p><h2 id=what-well-do>What we'll do</h2><p>The resources we'll deploy use the Google Cloud <a href=https://cloud.google.com/free/>free-tier</a> extensively. If you leave it running, it should cost a little over $5 a month.</p><p>If you're not familiar with Terraform or haven't used the Google Provider, you can get started <a href=https://www.terraform.io/docs/providers/google/getting_started.html>here</a>. All of the resources it deploys will be in the free tier.</p><p>Terraform has a concept of remote backends which allow you to save the state of your deployments (not just on your machine). This is especially helpful if you have multiple team members.</p><p>Since we're already using Google Cloud we can use Google Cloud Storage to house our state. After changing some defaults we can run a few commands and have our cluster running.</p><h2 id=actually-do-it>Actually do it</h2><ul><li>Create a Google Cloud Storage Bucket following these <a href=https://cloud.google.com/storage/docs/creating-buckets>instructions</a></li><li>Clone the cheap-managed-kubernetes <a href=https://github.com/kasuboski/cheap-managed-kubernetes>repo</a></li><li>Modify <code>terraform.tfvars.example</code> with your gcp project and rename to <code>terraform.tfvars</code></li><li>Modify <code>backend.hcl.example</code> with the gcs bucket you created above and rename to <code>backend.hcl.example</code></li></ul><p>You should now be set up to deploy with Terraform. We'll initialize Terraform with our remote backend and run a plan. This plan will output what will be created (or destroyed). You can verify the output of the plan is correct and then run the apply.</p><ul><li><code>terraform init -backend-config=backend.hcl</code></li><li><code>terraform plan</code> This should say it will create a cluster and node pool.</li><li><code>terraform apply</code> This will actually create the cluster and node pool.</li><li>When you're done <code>terraform destroy</code></li></ul><h2 id=using-your-cluster>Using your cluster</h2><p>The output of the apply will give you the info you need to create a <code>kubeconfig</code> to be able to connect to your cluster. Since we're using GKE though, I find it easier to just use the <code>gcloud</code> command that will set your <code>kubeconfig</code> for you.</p><p>It should look something like <code>gcloud container clusters get-credentials my-poor-gke-cluster</code> where <code>my-poor-gke-cluster</code> is the name of the cluster resource in <code>main.tf</code></p><p>Once you have your <code>kubeconfig</code> set up, you can access your cluster like you normally would. Maybe try running <code>kubectl get pods --all-namespaces</code>. You should see the pods that make up <code>kube-system</code>.</p></section><footer><a class="permalink u-url" href=https://joshkasuboski.com/posts/cheap-managed-kube/>ðŸ”—</a></footer></article></div><div class=h-card><img class=u-photo src=https://joshkasuboski.com/img/josh-scotland.jpg><div class=card-content><h2 class=card-name><a class="p-name u-url" href=https://joshkasuboski.com/ rel=me>Josh Kasuboski</a></h2><p class=card-subhead><span class=p-locality>Austin</span>,
<span class=p-country-name>United States</span><br><a class=u-email href=mailto:josh.kasuboski@gmail.com>Email me</a></p></div><p class=p-note>Josh Kasuboski is currently interested in developer productivity. He works to make it easier for a developer to go from works on my laptop to rock solid in production.</p></div><div id=footer><nav id=article-skip><div class=next><a alt="Newer article" href=https://joshkasuboski.com/now/>&larr; Newer</a></div><div class=top><a alt="Top of page" href=#>Top</a></div><div class=prev><a alt="Older article" href=https://joshkasuboski.com/about/>Older &rarr;</a></div></nav><aside id=social><div id=social-icons><div class=icon-24x24><a class=glyph alt="Email me" href=mailto:josh.kasuboski@gmail.com><img src=https://joshkasuboski.com/icons/envelope.svg height=24px width=24px></a></div><div class=icon-24x24><a class=glyph alt="GitHub profile" href=https://github.com/kasuboski><img src=https://joshkasuboski.com/icons/github.svg height=24px width=24px></a></div><div class=icon-24x24><a class=glyph alt="LinkedIn profile" href=https://www.linkedin.com/in/joshkasuboski><img src=https://joshkasuboski.com/icons/linkedin.svg height=24px width=24px></a></div></div></aside><p class=copyright>Copyright Â© 2019, Josh Kasuboski</p></div></body></html>