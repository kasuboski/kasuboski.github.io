<!doctype html><html lang=en-US><head><meta charset=utf-8><title>NixOS Dev Environment on Mac | Josh Kasuboski</title>
<meta name=description content="Josh Kasuboski's personal site"><meta name=author content="Josh Kasuboski"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.joshkasuboski.com/img/josh-scotland-full.jpg"><meta name=twitter:title content="NixOS Dev Environment on Mac"><meta name=twitter:description content="I needed more trend in my dev environment setup. Now more reproducible and declarative."><meta property="og:url" content="https://www.joshkasuboski.com/posts/nix-dev-environment/"><meta property="og:site_name" content="Josh Kasuboski"><meta property="og:title" content="NixOS Dev Environment on Mac"><meta property="og:description" content="I needed more trend in my dev environment setup. Now more reproducible and declarative."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-24T21:17:07-06:00"><meta property="article:modified_time" content="2023-01-24T21:17:07-06:00"><meta property="og:image" content="https://www.joshkasuboski.com/img/josh-scotland-full.jpg"><link rel=me href=mailto:josh.kasuboski@gmail.com><link rel=me href=https://github.com/kasuboski><link data-proofer-ignore rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link data-proofer-ignore rel=microsub href=https://microsub.joshcorp.co/microsub><link rel=alternate type=application/rss+xml href=https://www.joshkasuboski.com/index.xml><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://unpkg.com/turretcss/dist/turretcss.min.css crossorigin=anonymous><style>@media only screen and (min-width:768px){:root{font-size:18px}}body{background-color:#faf9fa}pre{background-color:#d4f2e1}a{text-decoration-color:#5965f9}#site-header{box-shadow:0 4px 12px rgba(0,0,0,5%)}#intro{background-color:#e6e8fe}#social a{color:transparent;text-decoration:none}</style></head><body><div class=padding-bottom-s><header id=site-header><div class="container max-width-l flex-justify-center padding-vertical-xs"><h1 class=no-margin-bottom><a class="text-decoration-none flex align-items-center" href=https://www.joshkasuboski.com/><img alt="jk logo" class="icon-s margin-right-xs" src=https://www.joshkasuboski.com/images/jk-logo.svg><small>Josh Kasuboski</small></a></h1><nav class=nav-inline><ul><li><a href=/about/>About</a></li><li><a href=/now/>Now</a></li></ul></nav></div></header><main class="container max-width-l margin-top-l"><article class=h-entry><header><h1 class="display-title-xl no-margin-bottom post-title p-name">NixOS Dev Environment on Mac</h1><p class="post-date no-margin-top">Posted on
<time class=dt-published datetime=2023-01-24T21:17:07-06:00>24 January, 2023
</time>by <a href=https://www.joshkasuboski.com/ class="p-author h-card" rel=author>Josh Kasuboski</a> Â· 5min read</p></header><section class="content e-content margin-top-l"><p>I needed more trend in my dev environment setup. Now more reproducible and declarative.</p><h2 id=nix>Nix?</h2><p>Nix gets to be many things. There&rsquo;s an expression language, package manager, and operating system built around it. You can learn more at <a href=https://nixos.org/learn.html>nixos.org</a>. I was mostly interested in using NixOS the operating system. It hopes to enable declarative and reproducible builds.</p><p>I had seen Mitchell Hashimoto&rsquo;s <a href=https://github.com/mitchellh/nixos-config>dev setup</a> that uses a NixOS VM on his mac in VMWare Fusion. It looked like it could solve many of the issues I had with random configs that you forget about polluting your machine. You not only declaratively specify what you want, but it can also be separate from your mac.</p><p>The Nix expression language was a little much to get used to, but I have been dabbling for awhile. It seems like Nix Flakes are starting to actually happen now as well (even though they&rsquo;re still experimental). They helped ease my confusion around the package manager channels and versions you would previously use (I think). I went straight to flakes.</p><h2 id=my-setup>My setup</h2><p>I decided I also wanted to try out <a href=https://github.com/lima-vm/lima>Lima</a> at the same time because why not do two new things. Lima is a nice interface to run linux virtual machines on Mac. You define a <code>yaml</code> file that specifies the image and directories you want to use along with cpu and memory and then you get a linux VM.</p><p>Most of my struggle was trying to get NixOS to run with Lima. Lima expects certain things to be configured on boot and from cloud-init. NixOS generally doesn&rsquo;t ship with cloud-init in the images and I wanted to keep most things in the Nix config. I had found a <a href=https://github.com/patryk4815/ctftools/tree/master/lima-vm>repo</a> that worked for me, but I had a hard time using my separate flake to reconfigure. It turns out the alpine image for Lima also doesn&rsquo;t have cloud-init. It instead has a bash script to set things up. I just needed to have my lima image run a similar script on startup.</p><p>Nix makes it rather simple to add systemd units like below. It&rsquo;s pretty similar to the actual format and you just substitute in your script inline.</p><pre tabindex=0><code>systemd.services.lima-init = {
    inherit script;
    description = &#34;Reconfigure the system from lima-init userdata on startup&#34;;

    after = [ &#34;network-pre.target&#34; ];

    restartIfChanged = true;
    unitConfig.X-StopOnRemoval = false;

    serviceConfig = {
        Type = &#34;oneshot&#34;;
        RemainAfterExit = true;
    };
};
</code></pre><p>I was using my configuration in a nix flake to use <a href=https://github.com/nix-community/nixos-generators>nixos-generators</a> to make an image that would then let me boot into NixOS directly. I was very much learning Nix as I went so have no idea if I landed on a good setup. My flake ended up with an <code>img</code> output that would make the image and then I could add my separate config as a different target.</p><p>You can see my image base at <a href=https://github.com/kasuboski/nixos-lima>kasuboski/nixos-lima</a>. It also has an example of user specific configuration. I couldn&rsquo;t decide how to add a user configuration, but eventually realized how to use the output of another flake and decided to move my user config to my dotfiles repo.</p><h2 id=the-actual-user-config>The actual user config</h2><p>At the time of writing this, I haven&rsquo;t merged the PR with my Nix changes to my dotfiles <a href=https://github.com/kasuboski/dotfiles/tree/nixos/nixos>repo</a>. While getting it working, I decided to do it piecemeal. I had recently switched to using <a href=https://www.joshkasuboski.com/posts/local-tools-asdf/>asdf</a> and there really isn&rsquo;t anything wrong with that setup. The way I set it up felt like a lot of indirection though and I was still going to be using <code>brew</code> for most things.</p><p>My hope with Nix is to use it on Mac with a linux VM, on a cloud VM, or maybe in a container and have a similar experience across them all. I currently have my main shell config installing system-wide for NixOS as well as <code>chezmoi</code>. I can then use my previous setup using <code>asdf</code> and <code>chezmoi</code> to set up my dotfiles. I&rsquo;m not quite ready to dive into the more Nixy <a href=https://github.com/nix-community/home-manager>home-manager</a> although it does seem nice.</p><p>I&rsquo;m still missing a bunch of things especially like cloud clis, but when needed I tend to use a <code>nix shell</code>. This lets you temporarily add packages to your environment without them being global. It is a little annoying typing out the packages to add so I eventually want to either make project specific settings or maybe have flakes based on what I&rsquo;m doing.</p><p>They could be for example DevOps/cloudy or language specific. Luc Perkins has started something similar at <a href=https://github.com/the-nix-way/dev-templates>the-nix-way/dev-templates</a>. They generally use <code>nix develop</code>, which (I believe) is meant for when you are developing a package so it isolates to just the items defined there. I&rsquo;d prefer to keep my <code>fish</code> shell and settings instead.</p><h2 id=moving-forward>Moving Forward</h2><p>I like the setup for now. I definitely want to test it out on other platforms and see how portable my config really is. Flakes for NixOS seem pretty new and I had a hard time finding examples. Even a lot of the examples I did find were very much focused on homelabs and baremetal machines where you would know all the details ahead of time and statically.</p><p>It made it quite hard to understand how my config should deal with not knowing until boot what the user should be and I&rsquo;m not really used to having a configuration per instance as the examples were per host. It feels a little like managing pets vs cattle.</p><p>Even <code>nixos-rebuild switch</code> defaulting to a configuration using the hostname was hard to get in the right mindset for. I&rsquo;ve grown accustomed to the hostname being generated and I ran into an issue where my work macbook needed a different architecture, but had the same Lima hostname. My config now has duplicate lima entries <code>nixos</code> and the unimaginative <code>nixos86</code>.</p></section><footer class=margin-top-m><a class="permalink u-url text-decoration-none" href=https://www.joshkasuboski.com/posts/nix-dev-environment/>ðŸ”—</a></footer></article><nav class="margin-top-l flex justify-content-space-around"><div><a alt="Newer article" href=https://www.joshkasuboski.com/posts/nixos-nas/>&larr; NixOS NAS</a></div><div class=show-s-up><a data-proofer-ignore alt="Top of page" href=#>Top</a></div><div><a alt="Older article" href=https://www.joshkasuboski.com/posts/google-saved-places-update/>Exporting Google Saved Places Update &rarr;</a></div></nav></main><footer class="container max-width-l margin-top-xl"><div class=margin-bottom-m><h4>Get more of my thoughts in an email newsletter!</h4><form action=https://buttondown.email/api/emails/embed-subscribe/kasuboski method=post target=popupwindow onsubmit='window.open("https://buttondown.email/kasuboski","popupwindow")' class=embeddable-buttondown-form><label for=bd-email>Your Email</label>
<input type=email name=email id=bd-email placeholder=me@email.com></input>
<input type=hidden value=1 name=embed></input>
<button class="button button-primary button-border" type=submit value=Subscribe>Subscribe</button><p class=font-size-s><a href=https://buttondown.email target=_blank>Powered by Buttondown.</a></p></form></div><div class="box-shadow-l padding-m"><div class="h-card flex align-content-center"><figure class=icon-xxl><img alt="profile photo" class=u-photo src=https://www.joshkasuboski.com/img/josh-scotland.jpg></figure><div class=margin-left-m><h3 class=display-title><a class="u-url p-name text-decoration-none" href=https://www.joshkasuboski.com/>Josh Kasuboski</a></h3><p>Living in Austin <img class=icon-xs style=vertical-align:middle alt=texas src=https://www.joshkasuboski.com/img/tx-fill.png> from <img class=icon-xs style=vertical-align:middle alt=wisconsin src=https://www.joshkasuboski.com/img/wi-fill.png></p><p id=social><a rel=me class="u-url margin-right-xs" href=https://github.com/kasuboski><img class=icon-xs src=https://www.joshkasuboski.com/icons/github.svg alt=github>
</a><a class=margin-right-xs href=https://linkedin.com/in/joshkasuboski/><img class=icon-xs src=https://www.joshkasuboski.com/icons/linkedin.svg alt=linkedin>
</a><a href=mailto:josh.kasuboski@gmail.com class="u-email margin-right-xxs" rel=me><img class=icon-xs src=https://www.joshkasuboski.com/icons/envelope.svg alt=email>
</a><a href=https://www.joshkasuboski.com/payments/><img class=icon-xs src=https://www.joshkasuboski.com/icons/beer-money-icon.svg alt=beermoney></a></p></div></div></div></footer></div><script async src=https://rum.cronitor.io/script.js></script><script>window.cronitor=window.cronitor||function(){(window.cronitor.q=window.cronitor.q||[]).push(arguments)},cronitor("config",{clientKey:"b2a9cb0f440d559169438f89c882dddb"})</script></body></html>