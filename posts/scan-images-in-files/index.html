<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8">
  
  <title>Scan Container Images Found in Files | Josh Kasuboski</title>
  <meta name="description" content="Josh Kasuboski&#39;s personal site">
  <meta name="author" content="">
  
  
  <link rel="me" href="mailto:josh.kasuboski@gmail.com">
  
  <link rel="me" href="https://github.com/kasuboski">
  
  
  
  <link data-proofer-ignore rel="authorization_endpoint" href="https://indieauth.com/auth">
  <link rel="token_endpoint" href=https://tokens.indieauth.com/token />
  
  <link data-proofer-ignore rel="microsub" href="https://microsub.joshcorp.co/microsub" />
  <link rel="alternate" type="application/rss+xml" href=https://www.joshkasuboski.com/index.xml />

  <meta name="viewport" content="width=device-width,initial-scale=1">


  <link rel="stylesheet" href="https://unpkg.com/turretcss/dist/turretcss.min.css" crossorigin="anonymous">

  <style>
     
    @media only screen and (min-width: 768px) {
      :root {
        font-size: 18px;
      }
    }

    body {
      background-color: #FAF9FA;
    }

    pre {
      background-color: rgba(212, 242, 225, 1);
    }

    a {
      text-decoration-color: rgba(89, 101, 249, 1);
    }

    #site-header {
      box-shadow: 0 4px 12px 0 rgba(0, 0, 0, 0.05);
    }

    #intro {
      background-color: rgba(230, 232, 254, 1);
    }

    #social a {
      color: transparent;
      text-decoration: none;
    }
  </style>
</head>
<body>
  <div class="padding-bottom-s">
    <header id="site-header">
      <div class="container max-width-l flex-justify-center padding-vertical-xs">
        <h1 class="no-margin-bottom"><a class="text-decoration-none flex align-items-center" href="https://www.joshkasuboski.com/"><img alt="jk logo" class="icon-s margin-right-xs" src=https://www.joshkasuboski.com/images/jk-logo.svg /><small>Josh Kasuboski</small></a></h1>
        <nav class="nav-inline">
  
  <ul>
    
    <li>
      <a href="/about/">About</a>
    </li>
    
    <li>
      <a href="/now/">Now</a>
    </li>
    
  </ul>
</nav>
      </div>
    </header>
    <main class="container max-width-l margin-top-l">



    <article class="h-entry">
        <header>
            <h1 class="display-title-xl no-margin-bottom post-title p-name">Scan Container Images Found in Files</h1>
            
            <p class="post-date no-margin-top">Posted on
                <time class="dt-published" datetime="2020-10-01T11:29:05-05:00">
                1 October, 2020
                </time>  by <a href="https://www.joshkasuboski.com/" class="p-author h-card" rel="author">Josh Kasuboski</a> ¬∑ 3min read
            </p>
            
            
        </header>
        <section class="content e-content margin-top-l">
            <p>I previously had been scanning images ad-hoc using Trivy. Now I can scan everything in my GitOps repo.</p>
<p>The previous post about Trivy is <a href="https://www.joshkasuboski.com/posts/image-scanning-trivy/">here</a>.</p>
<h2 id="finding-the-images-to-scan">Finding the Images to Scan</h2>
<p>Since I track all of my deployments in git at <a href="https://github.com/kasuboski/k8s-gitops">kasuboski/k8s-gitops</a>, I can find all of the images from the files in that repo. For the simple case of just finding it from Kubernetes objects, I can use the command below which finds the images, removes quotes, and makes sure it's unique. Magic üßô‚Äç‚ôÇÔ∏è.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ack --type yaml <span style="color:#e6db74">&#39;image: (.*)&#39;</span> --output <span style="color:#e6db74">&#39;$1&#39;</span> -h --nobreak | tr -d <span style="color:#ae81ff">\&#34;</span><span style="color:#ae81ff">\&#39;</span> | sort -u
</code></pre></div><p>This outputs everything coming after &ldquo;image: &ldquo;. This works for Kubernetes resources and it also picked up some values in a helm values file. I render manifests using kustomize, which can change images and pull remotely. This means I should really be running this command on the rendered manifests.</p>
<p>I've been considering rendering everything in git instead of only on the cluster (in ArgoCD). This would capture the exact yaml that was applied and make this analysis easier.</p>
<h2 id="scanning-with-trivy">Scanning with Trivy</h2>
<p>You can use <code>xargs</code> to run a scan for each image. I did this initially just piping to <code>trivy image</code>, but immediately hit the GitHub rate-limit. I thought trivy would reuse the database cache, but that didn't seem to be happening. They do let you pass a <a href="https://github.com/aquasecurity/trivy#github-rate-limiting">GitHub Token</a> to increase the limit, but that seemed like more effort.</p>
<p>Instead, I decided to use the client server mode of trivy. This let's you run a server that executes the scans and your client communicates with it.</p>
<p>To start the server:</p>
<pre><code>trivy server
</code></pre><p>Then (in another terminal) run a <code>trivy client</code> for each image:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ack --type yaml <span style="color:#e6db74">&#39;image: (.*)&#39;</span> --output <span style="color:#e6db74">&#39;$1&#39;</span> -h --nobreak | tr -d <span style="color:#ae81ff">\&#34;</span><span style="color:#ae81ff">\&#39;</span> | sort -u | xargs -L1 trivy client --severity HIGH,CRITICAL --ignore-unfixed
</code></pre></div><p>This gives output like below:
<figure><a href="results.png">
    <img src="results.png"
         alt="Trivy Results"/> </a>
</figure>
</p>
<p>It did fail to analyze an image that only had an ARM manifest (I ran this on my amd64 desktop)</p>
<h2 id="next-steps-">Next Steps ü¶∂</h2>
<p>I would like to run this repeatedly as a GitHub Action on the repo itself. It might be easier to just use a GitHub Token for the rate-limit in that case. I also want to analyze the rendered manifests.</p>
<p>I have been considering setting up my own registry to mirror my images such as <a href="https://goharbor.io/">Harbor</a>. Harbor can run periodic Trivy scans by itself and make the results available. There is also a an experimental <a href="https://github.com/aquasecurity/trivy-enforcer">trivy-enforcer</a> project that runs in the cluster and can enforce that all images running in your cluster are secure.</p>
<p>This combination of static analysis and runtime enforcement should make it pretty tough to have a known bad image running.</p>
        </section>
        <footer class="margin-top-m">
            <a class="permalink u-url text-decoration-none" href="https://www.joshkasuboski.com/posts/scan-images-in-files/">üîó</a>
            
        </footer>
    </article>
    
    <nav class="margin-top-l flex justify-content-space-around">
        <div>
            
                
                <a alt="Newer article" href="https://www.joshkasuboski.com/posts/htmltest-githubactions/">&larr; Test HTML in GitHub Actions</a>
                
            
            
        </div>
        <div class="show-s-up">
            <a data-proofer-ignore alt="Top of page" href="#">Top</a>
        </div>
        <div>
            
                
                <a alt="Older article" href="https://www.joshkasuboski.com/posts/image-scanning-trivy/">Container Image Scanning with Trivy &rarr;</a>
                
            
            
        </div>
    </nav>
    
</main>
<footer class="container max-width-l margin-top-xl">
  <div class="box-shadow-l padding-m">
    <div class="h-card flex align-content-center">
      <figure class="icon-xxl">
        <img alt="profile photo" class="u-photo" src="https://www.joshkasuboski.com/img/josh-scotland.jpg" />
      </figure>
      <div class="margin-left-m">
        <h3 class="display-title"><a class="u-url p-name text-decoration-none" href="https://www.joshkasuboski.com/">Josh Kasuboski</a></h3>
        <p>Living in Austin <img class="icon-xs" style="vertical-align: middle;" alt="texas" src=https://www.joshkasuboski.com/img/tx-fill.png /> from <img class="icon-xs" style="vertical-align: middle;"
            alt="wisconsin" src=https://www.joshkasuboski.com/img/wi-fill.png /></p>
        <p id="social">
          <a rel="me" class="u-url margin-right-xs" href="https://github.com/kasuboski">
            <img class="icon-xs" src=https://www.joshkasuboski.com/icons/github.svg alt="github" />
          </a>
          <a class="margin-right-xs" href="https://linkedin.com/in/joshkasuboski/">
            <img class="icon-xs" src=https://www.joshkasuboski.com/icons/linkedin.svg alt="linkedin" />
          </a>
          <a href="mailto:josh.kasuboski@gmail.com" class="u-email margin-right-xxs" rel="me">
            <img class="icon-xs" src=https://www.joshkasuboski.com/icons/envelope.svg alt="email" />
          </a>

          <button class="button button-icon button-xs" style="background-color:transparent;padding:0;border:0;"
            id="checkout-button-beermoney" role="link" type="button">
            <img class="icon-xs" src=https://www.joshkasuboski.com/icons/beer-money-icon.svg alt="beermoney" />
          </button>
        </p>
      </div>
    </div>
  </div>
</footer>
</div>

<script>
  (function (f, a, t, h, o, m) {
    a[h] = a[h] || function () {
      (a[h].q = a[h].q || []).push(arguments)
    };
    o = f.createElement('script'),
      m = f.getElementsByTagName('script')[0];
    o.async = 1; o.src = t; o.id = 'fathom-script';
    m.parentNode.insertBefore(o, m)
  })(document, window, 'https://fathom.joshcorp.co/tracker.js', 'fathom');
  fathom('set', 'siteId', 'XFQVM');
  fathom('trackPageview');
</script>

<script src="https://js.stripe.com/v3"></script>
<script>
  (function () {
    var DOMAIN = 'https://www.joshkasuboski.com/';
    var key = 'pk_live_51HJtKkASjDZJS9C9Ja9g6zTFbaTEdW7uCK2OTK1dq741RisoSBtSIac1QEMphVCEEkA7hTeuopkUsajAyWuyH7kT00cU4iVGfX';
    var price = 'price_1HJtUTASjDZJS9C90kJjztUq';
    
    
    var stripe = Stripe(key);

    var checkoutButton = document.getElementById('checkout-button-beermoney');
    checkoutButton.addEventListener('click', function () {
      
      
      stripe.redirectToCheckout({
        lineItems: [{ price: price, quantity: 1 }],
        mode: 'payment',
        
        
        
        
        
        successUrl: DOMAIN + 'success',
        cancelUrl: DOMAIN + 'canceled',
      })
        .then(function (result) {
          if (result.error) {
            
            
            var displayError = document.getElementById('error-message');
            displayError.textContent = result.error.message;
          }
        });
    });
  })();
</script>
</body>

</html>
