<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Migrating to Free Heroku Postgres (or not) | Josh Kasuboski</title><meta name=description content="Josh Kasuboski's personal site"><meta name=author content><link rel=me href=mailto:josh.kasuboski@gmail.com><link rel=me href=https://github.com/kasuboski><link data-proofer-ignore rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link data-proofer-ignore rel=microsub href=https://microsub.joshcorp.co/microsub><link rel=alternate type=application/rss+xml href=https://www.joshkasuboski.com/index.xml><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://unpkg.com/turretcss/dist/turretcss.min.css crossorigin=anonymous><style>@media only screen and (min-width:768px){:root{font-size:18px}}body{background-color:#faf9fa}pre{background-color:#d4f2e1}a{text-decoration-color:#5965f9}#site-header{box-shadow:0 4px 12px 0 rgba(0,0,0,.05)}#intro{background-color:#e6e8fe}#social a{color:transparent;text-decoration:none}</style></head><body><div class=padding-bottom-s><header id=site-header><div class="container max-width-l flex-justify-center padding-vertical-xs"><h1 class=no-margin-bottom><a class="text-decoration-none flex align-items-center" href=https://www.joshkasuboski.com/><img alt="jk logo" class="icon-s margin-right-xs" src=https://www.joshkasuboski.com/images/jk-logo.svg><small>Josh Kasuboski</small></a></h1><nav class=nav-inline><ul><li><a href=/about/>About</a></li><li><a href=/now/>Now</a></li></ul></nav></div></header><main class="container max-width-l margin-top-l"><article class=h-entry><header><h1 class="display-title-xl no-margin-bottom post-title p-name">Migrating to Free Heroku Postgres (or not)</h1><p class="post-date no-margin-top">Posted on
<time class=dt-published datetime=2021-06-29T15:17:39-05:00>29 June, 2021</time> by <a href=https://www.joshkasuboski.com/ class="p-author h-card" rel=author>Josh Kasuboski</a> Â· 4min read</p></header><section class="content e-content margin-top-l"><p>I want to move my miniflux database to a managed service. Spoilers&mldr; it didn't go well.</p><h2 id=current-setup>Current setup</h2><p>I currently have <a href=https://miniflux.app/>miniflux</a> running in my <a href=https://www.joshkasuboski.com/posts/home-k8s-raspberry-update/>raspberry pi kubernetes cluster</a>. Miniflux requires a Postgresql database. I haven't had great experiences running persistent storage on the Raspberry Pis so I opted to run the database on my thinkcentre instead. It's running as a container and hasn't been an issue since.</p><p>There have been times however, where I have broken my entire homelab. The power grid in Texas has also been less than reliable ðŸ¥¶. It was rather annoying to be freezing and also not have access to my feed reader. Since I want my feed reader to be more available than my homelab permits, I'm naturally trying to extend to the cloud.</p><h2 id=managing-the-database>Managing the Database</h2><p>Free managed databases seem to be hard to come by. Many cloud providers offer them in the trial period, but not in the always-free plans. Heroku, however, has a pretty nice offering.</p><p>You get 1GB of storage and 10,000 rows. You're even able to retain 2 backups. I checked my current miniflux database and it's only using 150 MB. There should be plenty of room to grow. I think miniflux also clears entries after a certain period.</p><p>I created a Postgresql add-on in the Heroku console. They only really tell you how to connect from a Heroku app, which isn't what I'm after. I eventually found this help <a href=https://devcenter.heroku.com/articles/connecting-to-heroku-postgres-databases-from-outside-of-heroku>doc</a> that pretty explicitly says you shouldn't rely on the connection info statically. The recommended option is to use the Heroku cli to get your connection string.</p><p>At first, I tried to create a container that has the Heroku cli in it. Unfortunately, it wouldn't build for ARM, which I need for the Pis and my upcoming free Oracle ARM VM. I still built it for amd64 so if that's all you need it's at <a href=https://github.com/kasuboski/heroku-cli>kasuboski/heroku-cli</a>.</p><p>My next idea was to just call the API directly. There are a couple of clients to help. The Golang one hadn't been updated in years so I went with <a href=https://github.com/heroku/node-heroku-client>nodejs</a>. You can see the project I made at <a href=https://github.com/kasuboski/heroku-ps-url-grabber>kasuboski/heroku-ps-url-grabber</a>.</p><p>It's a bit of a mouthful, but it will get the config variables associated with your Heroku app. In my case, it only has a <code>DATABASE_URL</code> for the Postgresql addon. This little script means I can get the connection string and store it in a file that miniflux can read.</p><h2 id=migrating-to-the-managed-database>Migrating to the Managed Database</h2><p>After getting that working and building on ARM, I moved on to migrating the data. The Heroku cli has a nice <a href=https://devcenter.heroku.com/articles/heroku-postgresql#pg-push>pg:push</a> command that will push from one Postgresql to the one in your account. It took me a second to figure out how to have it point to another host, but once it did everything went smoothly. An example command is below.</p><pre><code>heroku pg:push postgres://user:pass@olddb/miniflux postgresql-random-id --app your-app
</code></pre><p>I was adding an initContainer to my miniflux kubernetes deployment, when I noticed an email from Heroku. My database had 16,000 rows and would have <code>INSERT</code> permission removed in 6 hours. The miniflux backup apparently contained 16,000 rows, far above the 10,000 free limit ðŸ˜’.</p><p>The free Heroku Postgresql isn't going to work for me it seems.</p><h2 id=next-steps>Next Steps</h2><p>I still want to get my miniflux running elsewhere (or at least have the ability to easily switch it). I had been considering adding a cloud node to my cluster. Once that is setup, I will look into running miniflux on that including its postgres.</p><p>I have been wanting to do something like <a href=https://itnext.io/how-to-deploy-a-single-kubernetes-cluster-across-multiple-clouds-using-k3s-and-wireguard-a5ae176a6e81>this</a>. I already run <a href=https://tailscale.com/>tailscale</a> on all of my nodes so running the kubernetes control plane in the cloud with nodes spread about may be the perfect solution.</p><p>You can see what my tailscale setup is like in <a href=https://www.joshkasuboski.com/posts/connect-home-cloud-tailscale/>Connect Your Home to the Cloud with Tailscale</a>. Oracle was currently out of capacity for ARM VMs, but hopefully I'll be able to provision soon.</p></section><footer class=margin-top-m><a class="permalink u-url text-decoration-none" href=https://www.joshkasuboski.com/posts/migrating-to-free-heroku-postgres/>ðŸ”—</a></footer></article><nav class="margin-top-l flex justify-content-space-around"><div><a alt="Newer article" href=https://www.joshkasuboski.com/posts/moving-cluster-to-the-cloud/>&larr; Moving My Cluster to the Cloud</a></div><div class=show-s-up><a data-proofer-ignore alt="Top of page" href=#>Top</a></div><div><a alt="Older article" href=https://www.joshkasuboski.com/posts/m1-macbook-setup/>M1 Macbook Air Setup &rarr;</a></div></nav></main><footer class="container max-width-l margin-top-xl"><div class=margin-bottom-m><h4>Get more of my thoughts in an email newsletter!</h4><form action=https://buttondown.email/api/emails/embed-subscribe/kasuboski method=post target=popupwindow onsubmit="window.open('https://buttondown.email/kasuboski','popupwindow')" class=embeddable-buttondown-form><label for=bd-email>Your Email</label>
<input type=email name=email id=bd-email placeholder=me@email.com></input>
<input type=hidden value=1 name=embed></input>
<button class="button button-primary button-border" type=submit value=Subscribe>Subscribe</button><p class=font-size-s><a href=https://buttondown.email target=_blank>Powered by Buttondown.</a></p></form></div><div class="box-shadow-l padding-m"><div class="h-card flex align-content-center"><figure class=icon-xxl><img alt="profile photo" class=u-photo src=https://www.joshkasuboski.com/img/josh-scotland.jpg></figure><div class=margin-left-m><h3 class=display-title><a class="u-url p-name text-decoration-none" href=https://www.joshkasuboski.com/>Josh Kasuboski</a></h3><p>Living in Austin <img class=icon-xs style=vertical-align:middle alt=texas src=https://www.joshkasuboski.com/img/tx-fill.png> from <img class=icon-xs style=vertical-align:middle alt=wisconsin src=https://www.joshkasuboski.com/img/wi-fill.png></p><p id=social><a rel=me class="u-url margin-right-xs" href=https://github.com/kasuboski><img class=icon-xs src=https://www.joshkasuboski.com/icons/github.svg alt=github></a>
<a class=margin-right-xs href=https://linkedin.com/in/joshkasuboski/><img class=icon-xs src=https://www.joshkasuboski.com/icons/linkedin.svg alt=linkedin></a>
<a href=mailto:josh.kasuboski@gmail.com class="u-email margin-right-xxs" rel=me><img class=icon-xs src=https://www.joshkasuboski.com/icons/envelope.svg alt=email></a>
<a href=https://www.joshkasuboski.com/payments/><img class=icon-xs src=https://www.joshkasuboski.com/icons/beer-money-icon.svg alt=beermoney></a></p></div></div></div></footer></div><script async src="https://cdn.panelbear.com/analytics.js?site=FK681rNQuKp"></script><script>window.panelbear=window.panelbear||function(){window.panelbearQ=window.panelbearQ||[];panelbearQ.push(arguments);};panelbear('config',{site:'FK681rNQuKp'});</script></body></html>