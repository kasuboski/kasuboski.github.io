<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Connect to Kubernetes Pods with Tailscale | Josh Kasuboski</title><meta name=description content="Josh Kasuboski's personal site"><meta name=author content="Josh Kasuboski"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.joshkasuboski.com/img/josh-scotland-full.jpg"><meta name=twitter:title content="Connect to Kubernetes Pods with Tailscale"><meta name=twitter:description content="I wasn't ready to add auth to my new feedreader. So I built a moat with Tailscale."><meta property="og:title" content="Connect to Kubernetes Pods with Tailscale"><meta property="og:description" content="I wasn't ready to add auth to my new feedreader. So I built a moat with Tailscale."><meta property="og:type" content="article"><meta property="og:url" content="https://www.joshkasuboski.com/posts/tailscale-connect-kubernetes-pods/"><meta property="og:image" content="https://www.joshkasuboski.com/img/josh-scotland-full.jpg"><meta property="article:published_time" content="2022-04-03T13:52:19-05:00"><meta property="article:modified_time" content="2022-04-03T13:52:19-05:00"><link rel=me href=mailto:josh.kasuboski@gmail.com><link rel=me href=https://github.com/kasuboski><link data-proofer-ignore rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link data-proofer-ignore rel=microsub href=https://microsub.joshcorp.co/microsub><link rel=alternate type=application/rss+xml href=https://www.joshkasuboski.com/index.xml><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://unpkg.com/turretcss/dist/turretcss.min.css crossorigin=anonymous><style>@media only screen and (min-width:768px){:root{font-size:18px}}body{background-color:#faf9fa}pre{background-color:#d4f2e1}a{text-decoration-color:#5965f9}#site-header{box-shadow:0 4px 12px 0 rgba(0,0,0,.05)}#intro{background-color:#e6e8fe}#social a{color:transparent;text-decoration:none}</style></head><body><div class=padding-bottom-s><header id=site-header><div class="container max-width-l flex-justify-center padding-vertical-xs"><h1 class=no-margin-bottom><a class="text-decoration-none flex align-items-center" href=https://www.joshkasuboski.com/><img alt="jk logo" class="icon-s margin-right-xs" src=https://www.joshkasuboski.com/images/jk-logo.svg><small>Josh Kasuboski</small></a></h1><nav class=nav-inline><ul><li><a href=/about/>About</a></li><li><a href=/now/>Now</a></li></ul></nav></div></header><main class="container max-width-l margin-top-l"><article class=h-entry><header><h1 class="display-title-xl no-margin-bottom post-title p-name">Connect to Kubernetes Pods with Tailscale</h1><p class="post-date no-margin-top">Posted on
<time class=dt-published datetime=2022-04-03T13:52:19-05:00>3 April, 2022</time> by <a href=https://www.joshkasuboski.com/ class="p-author h-card" rel=author>Josh Kasuboski</a> Â· 3min read</p></header><section class="content e-content margin-top-l"><p>I wasn't ready to add auth to my new feedreader. So I built a moat with Tailscale.</p><h2 id=what-does-that-_mean_>What does that <em>mean</em>?</h2><p>I added a kubernetes pod to my tailnet so it's accessible from anywhere that can route to Tailscale nodes. It also gets a nice domain name so <code>http://feedreader</code> works.</p><p>Tailscale actually has a <a href=https://tailscale.com/blog/kubecon-21/>blog post</a> and <a href=https://github.com/tailscale/tailscale/tree/main/docs/k8s>example</a> for how to set this up. I wanted it to be mildly different so modified their run script. They also don't publish their example image so I needed to build one.</p><p>You can see my version at <a href=https://github.com/kasuboski/tailscale-proxy>kasuboski/tailscale-proxy</a>. The main differences are it takes a <code>HOSTNAME</code> and <code>DEST_PORT</code> parameters.</p><p>The <code>HOSTNAME</code> is so you can set the name the node will show up as. This was important for kubernetes because I don't want the generated name of the pod to be how I access it. <code>DEST_PORT</code> is so you can have it forward to a different port. This allows you to run your app on <code>8080</code>, but the <code>tailscale-proxy</code> will route any port to <code>8080</code> meaning you can hit it on <code>80</code> in your browser. This is required to not have <code>:8080</code> ugliness after your URL.</p><h2 id=but-why>But Why?</h2><p>I've been making a <a href=https://github.com/kasuboski/feedreader>feedreader</a> to replace my running <a href=https://miniflux.app/>miniflux</a>. It's my first <em>real</em> rust project and I wanted an even more minimal feedreader.</p><p>I haven't gotten around to figuring out users or authentication in the feedreader though. Despite this, it finally reached the point where I can use it as my main feedreader. However, I didn't exactly want an unauthenticated app hanging out on the internet for someone to ruin my day.</p><p>If you don't want to make authentication, just make it inaccessible. This is where <a href=https://tailscale.com/>Tailscale</a> comes in. I already run Tailscale on all the nodes, which is how I'm able to have a <a href=https://www.joshkasuboski.com/posts/multi-region-k3s/>multi-region k3s cluster</a>. That doesn't make my pods routable though.</p><p>Tailscale has an option for a <a href=https://github.com/tailscale/tailscale/tree/main/docs/k8s#subnet-router>subnet router</a> that is actually highlighted as how to access all things k8s in the examples. This probably would have been nice (and I might still add it), but I wouldn't automatically get dns routing I believe.</p><p>You can see how it's all put together in my <a href=https://github.com/kasuboski/k8s-gitops/blob/main/default/feedreader/add-tailscale-proxy.yaml>k8s-gitops repo</a>. The gist is that you add a sidecar container that starts tailscale and in my case adds an <code>iptables</code> rule which forwards all traffic to the app port. You can see my poor Doppler secret naming in there too where everything is using <code>miniflux-secret</code>.</p><h2 id=so-no-more-auth>So, no more auth?</h2><p>I still want to add users to the feedreader so that you can have multiple users on one instance. It remains to be seen whether I'll just add basic auth or something more complicated. Tailscale let me focus on getting something usable quickly though.</p><p>After seeing how convenient it was to expose a pod with a dns name, I also want to make a debugging tool injecting tailscale to pods. I could then finely be rid of the finicky <code>kubectl port-forward</code>.</p></section><footer class=margin-top-m><a class="permalink u-url text-decoration-none" href=https://www.joshkasuboski.com/posts/tailscale-connect-kubernetes-pods/>ðŸ”—</a></footer></article><nav class="margin-top-l flex justify-content-space-around"><div><a alt="Newer article" href=https://www.joshkasuboski.com/posts/buildkit-builder/>&larr; Running a Buildkit ARM Builder</a></div><div class=show-s-up><a data-proofer-ignore alt="Top of page" href=#>Top</a></div><div><a alt="Older article" href=https://www.joshkasuboski.com/posts/multi-region-k3s/>Multi-Region K3s &rarr;</a></div></nav></main><footer class="container max-width-l margin-top-xl"><div class=margin-bottom-m><h4>Get more of my thoughts in an email newsletter!</h4><form action=https://buttondown.email/api/emails/embed-subscribe/kasuboski method=post target=popupwindow onsubmit="window.open('https://buttondown.email/kasuboski','popupwindow')" class=embeddable-buttondown-form><label for=bd-email>Your Email</label>
<input type=email name=email id=bd-email placeholder=me@email.com></input>
<input type=hidden value=1 name=embed></input>
<button class="button button-primary button-border" type=submit value=Subscribe>Subscribe</button><p class=font-size-s><a href=https://buttondown.email target=_blank>Powered by Buttondown.</a></p></form></div><div class="box-shadow-l padding-m"><div class="h-card flex align-content-center"><figure class=icon-xxl><img alt="profile photo" class=u-photo src=https://www.joshkasuboski.com/img/josh-scotland.jpg></figure><div class=margin-left-m><h3 class=display-title><a class="u-url p-name text-decoration-none" href=https://www.joshkasuboski.com/>Josh Kasuboski</a></h3><p>Living in Austin <img class=icon-xs style=vertical-align:middle alt=texas src=https://www.joshkasuboski.com/img/tx-fill.png> from <img class=icon-xs style=vertical-align:middle alt=wisconsin src=https://www.joshkasuboski.com/img/wi-fill.png></p><p id=social><a rel=me class="u-url margin-right-xs" href=https://github.com/kasuboski><img class=icon-xs src=https://www.joshkasuboski.com/icons/github.svg alt=github></a>
<a class=margin-right-xs href=https://linkedin.com/in/joshkasuboski/><img class=icon-xs src=https://www.joshkasuboski.com/icons/linkedin.svg alt=linkedin></a>
<a href=mailto:josh.kasuboski@gmail.com class="u-email margin-right-xxs" rel=me><img class=icon-xs src=https://www.joshkasuboski.com/icons/envelope.svg alt=email></a>
<a href=https://www.joshkasuboski.com/payments/><img class=icon-xs src=https://www.joshkasuboski.com/icons/beer-money-icon.svg alt=beermoney></a></p></div></div></div></footer></div><script async src=https://rum.cronitor.io/script.js></script><script>window.cronitor=window.cronitor||function(){(window.cronitor.q=window.cronitor.q||[]).push(arguments);};cronitor('config',{clientKey:'b2a9cb0f440d559169438f89c882dddb'});</script></body></html>