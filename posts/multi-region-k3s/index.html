<!doctype html><html lang=en-US><head><meta charset=utf-8><title>Multi-Region K3s | Josh Kasuboski</title>
<meta name=description content="Josh Kasuboski's personal site"><meta name=author content="Josh Kasuboski"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.joshkasuboski.com/img/josh-scotland-full.jpg"><meta name=twitter:title content="Multi-Region K3s"><meta name=twitter:description content="I had stood up a cluster in the cloud before moving. Now, I‚Äôve added some nodes at home to round it out. Maybe I‚Äôm just in it for the buzzwords."><meta property="og:url" content="https://www.joshkasuboski.com/posts/multi-region-k3s/"><meta property="og:site_name" content="Josh Kasuboski"><meta property="og:title" content="Multi-Region K3s"><meta property="og:description" content="I had stood up a cluster in the cloud before moving. Now, I‚Äôve added some nodes at home to round it out. Maybe I‚Äôm just in it for the buzzwords."><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-11-11T15:56:57-06:00"><meta property="article:modified_time" content="2021-11-11T15:56:57-06:00"><meta property="og:image" content="https://www.joshkasuboski.com/img/josh-scotland-full.jpg"><link rel=me href=mailto:josh.kasuboski@gmail.com><link rel=me href=https://github.com/kasuboski><link data-proofer-ignore rel=authorization_endpoint href=https://indieauth.com/auth><link rel=token_endpoint href=https://tokens.indieauth.com/token><link data-proofer-ignore rel=microsub href=https://microsub.joshcorp.co/microsub><link rel=alternate type=application/rss+xml href=https://www.joshkasuboski.com/index.xml><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://unpkg.com/turretcss/dist/turretcss.min.css crossorigin=anonymous><style>@media only screen and (min-width:768px){:root{font-size:18px}}body{background-color:#faf9fa}pre{background-color:#d4f2e1}a{text-decoration-color:#5965f9}#site-header{box-shadow:0 4px 12px rgba(0,0,0,5%)}#intro{background-color:#e6e8fe}#social a{color:transparent;text-decoration:none}</style></head><body><div class=padding-bottom-s><header id=site-header><div class="container max-width-l flex-justify-center padding-vertical-xs"><h1 class=no-margin-bottom><a class="text-decoration-none flex align-items-center" href=https://www.joshkasuboski.com/><img alt="jk logo" class="icon-s margin-right-xs" src=https://www.joshkasuboski.com/images/jk-logo.svg><small>Josh Kasuboski</small></a></h1><nav class=nav-inline><ul><li><a href=/about/>About</a></li><li><a href=/now/>Now</a></li></ul></nav></div></header><main class="container max-width-l margin-top-l"><article class=h-entry><header><h1 class="display-title-xl no-margin-bottom post-title p-name">Multi-Region K3s</h1><p class="post-date no-margin-top">Posted on
<time class=dt-published datetime=2021-11-11T15:56:57-06:00>11 November, 2021
</time>by <a href=https://www.joshkasuboski.com/ class="p-author h-card" rel=author>Josh Kasuboski</a> ¬∑ 3min read</p></header><section class="content e-content margin-top-l"><p>I had stood up a cluster in the cloud before moving. Now, I&rsquo;ve added some nodes at home to round it out. Maybe I&rsquo;m just in it for the buzzwords.</p><h2 id=why-not-just-the-cloud>Why not just the cloud?</h2><p>As previously mentioned in <a href=https://www.joshkasuboski.com/posts/moving-cluster-to-the-cloud/>moving my cluster to the cloud</a>, I run a VM for the control plane and then a free Oracle ARM 4x24 VM as a worker. You might think this is more than enough (and you&rsquo;d probably be right), but there are some things that make more sense to run at home.</p><p>I currently run media services and backups at home. I also hope to mess around with more home automation things in the future. The media consumption is nice to be local, but it also saves on cloud network transfer costs. Overall, the cloud worker VM is going to be much more reliable than the small form factor PCs that make up my home region.</p><h2 id=hows-it-actually-work>How&rsquo;s it actually work?</h2><p>I install <a href=https://tailscale.com/>Tailscale</a> on all of the machines. This lets them easily connect to each other as if they were on the same local network. The kubernetes API server only binds to the Tailscale interface so all of the workers are able to reach it. After setting this up, it mostly just works‚Ñ¢Ô∏è.</p><p>The nodes are separated into a cloud and home region. Each region is broken down into zones for the cloud provider or location. That ends up cloud-oracle, cloud-racknerd, home-austin, home-wisconsin region-zone pairs. I&rsquo;m then able to use those labels for scheduling decisions.</p><p>So far I&rsquo;m only using the zones for austin and wisconsin to pin my media options to the respective machines. Other things, including my RSS reader, are able to float between regions.</p><h2 id=the-setup>The Setup</h2><p>The cluster is still managed with GitOps from the repo <a href=https://github.com/kasuboski/k8s-gitops>kasuboski/k8s-gitops</a>. I&rsquo;m using ArgoCD to apply the manifests, but might mess with other options.</p><p>I recently changed the secrets management from <a href=https://github.com/bitnami-labs/sealed-secrets>SealedSecrets</a> to <a href=https://www.doppler.com/>Doppler</a>. There wasn&rsquo;t anything wrong with SealedSecrets, but it felt less magic since I had to make sure to manage the keys and reencrypt on changes. I have a script under <code>hack/</code> in the repo that manages importing the correct Doppler project token. After creating their <code>DopplerSecret</code> CRD, the secrets then just show up.</p><p>Previously, I had run a separate VM to act as the entrypoint to the cluster. Now I use a loadbalancer from Oracle that points to the free ARM VM there. The DNS then points to this loadbalancer. I still want to add a separate ingress locally so I can avoid always going out and back in, but haven&rsquo;t gotten around to it.</p><p>I also still have 4 Raspberry Pis that I haven&rsquo;t setup yet since moving. The general layout is as below.</p><figure><a href=homelab.png><img src=/posts/multi-region-k3s/homelab.png alt="Homelab Diagram"></a></figure><h2 id=further-improvements>Further Improvements</h2><p>I have a lot of the setup documented in <a href=https://github.com/kasuboski/home-infra>kasuboski/home-infra</a>, but realized as I was setting up the machine in Austin that it leaves a lot to be desired. In particular, the setup for storage had me looking back through the command history of the Wisconsin machine to figure out what I had done.</p><p>I&rsquo;m thinking to make a tool that will set this up or at least walk me through it. The <code>home-infra</code> repo needs to be cleaned up a little as well. It still contains instructions for multiple past iterations of my homelab.</p></section><footer class=margin-top-m><a class="permalink u-url text-decoration-none" href=https://www.joshkasuboski.com/posts/multi-region-k3s/>üîó</a></footer></article><nav class="margin-top-l flex justify-content-space-around"><div><a alt="Newer article" href=https://www.joshkasuboski.com/posts/tailscale-connect-kubernetes-pods/>&larr; Connect to Kubernetes Pods with Tailscale</a></div><div class=show-s-up><a data-proofer-ignore alt="Top of page" href=#>Top</a></div><div><a alt="Older article" href=https://www.joshkasuboski.com/posts/interact-blockchain-javascript/>Interact with Blockchain Apps in Javascript &rarr;</a></div></nav></main><footer class="container max-width-l margin-top-xl"><div class=margin-bottom-m><h4>Get more of my thoughts in an email newsletter!</h4><form action=https://buttondown.email/api/emails/embed-subscribe/kasuboski method=post target=popupwindow onsubmit='window.open("https://buttondown.email/kasuboski","popupwindow")' class=embeddable-buttondown-form><label for=bd-email>Your Email</label>
<input type=email name=email id=bd-email placeholder=me@email.com></input>
<input type=hidden value=1 name=embed></input>
<button class="button button-primary button-border" type=submit value=Subscribe>Subscribe</button><p class=font-size-s><a href=https://buttondown.email target=_blank>Powered by Buttondown.</a></p></form></div><div class="box-shadow-l padding-m"><div class="h-card flex align-content-center"><figure class=icon-xxl><img alt="profile photo" class=u-photo src=https://www.joshkasuboski.com/img/josh-scotland.jpg></figure><div class=margin-left-m><h3 class=display-title><a class="u-url p-name text-decoration-none" href=https://www.joshkasuboski.com/>Josh Kasuboski</a></h3><p>Living in Austin <img class=icon-xs style=vertical-align:middle alt=texas src=https://www.joshkasuboski.com/img/tx-fill.png> from <img class=icon-xs style=vertical-align:middle alt=wisconsin src=https://www.joshkasuboski.com/img/wi-fill.png></p><p id=social><a rel=me class="u-url margin-right-xs" href=https://github.com/kasuboski><img class=icon-xs src=https://www.joshkasuboski.com/icons/github.svg alt=github>
</a><a class=margin-right-xs href=https://linkedin.com/in/joshkasuboski/><img class=icon-xs src=https://www.joshkasuboski.com/icons/linkedin.svg alt=linkedin>
</a><a href=mailto:josh.kasuboski@gmail.com class="u-email margin-right-xxs" rel=me><img class=icon-xs src=https://www.joshkasuboski.com/icons/envelope.svg alt=email>
</a><a href=https://www.joshkasuboski.com/payments/><img class=icon-xs src=https://www.joshkasuboski.com/icons/beer-money-icon.svg alt=beermoney></a></p></div></div></div></footer></div><script async src=https://rum.cronitor.io/script.js></script><script>window.cronitor=window.cronitor||function(){(window.cronitor.q=window.cronitor.q||[]).push(arguments)},cronitor("config",{clientKey:"b2a9cb0f440d559169438f89c882dddb"})</script></body></html>